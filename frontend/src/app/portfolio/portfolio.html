@if (userId) {
<div class="portfolio-container">
  <div class="portfolio-header">
    <h2>Carteira de Investimentos - {{ userName }}</h2>
  </div>

  <!-- Tabs -->
  <div class="portfolio-tabs">
    <button class="tab-button" [class.active]="activeTab === 'acoes'" (click)="activeTab = 'acoes'">
      Ações
    </button>
    <button class="tab-button" [class.active]="activeTab === 'renda-fixa'" (click)="activeTab = 'renda-fixa'">
      Renda Fixa
    </button>
    <button class="tab-button" [class.active]="activeTab === 'historico'" (click)="activeTab = 'historico'">
      Histórico de Notas
    </button>
    <button class="tab-button" [class.active]="activeTab === 'allocation-strategy'"
      (click)="activeTab = 'allocation-strategy'">
      Estratégia de Alocação
    </button>
    <button class="tab-button" [class.active]="activeTab === 'crypto'" (click)="activeTab = 'crypto'">
      Criptomoedas
    </button>
    <button class="tab-button" [class.active]="activeTab === 'fiis'" (click)="activeTab = 'fiis'">
      Fundos Imobiliários
    </button>
  </div>

  <!-- Ações Tab Content -->
  @if (activeTab === 'acoes') {
  <section class="positions-section">
    <div class="section-header">
      <h3>Posições Atuais</h3>
    </div>

    @if (showPositions && positions.length > 0) {
    <div class="summary-cards">
      <div class="summary-card">
        <span class="label">Total Investido:</span>
        <span class="value">{{ formatCurrency(getTotalInvestido()) }}</span>
      </div>
      <div class="summary-card">
        <span class="label">Valor Atual:</span>
        <span class="value">{{ formatCurrency(getTotalValorAtual()) }}</span>
      </div>
      <div class="summary-card">
        <span class="label">Ativos na Carteira:</span>
        <span class="value">{{ getActivePositionsCount() }}</span>
      </div>
    </div>

    @for (group of getGroupedPositionsArray(); track group.key) {
      <div class="investment-type-group">
        <div class="investment-type-header">
          <h4>{{ group.name }}</h4>
          <div class="summary-cards">
            <div class="summary-card">
              <span class="label">Investido:</span>
              <span class="value">{{ formatCurrency(getTotalInvestidoForGroup(group.positions)) }}</span>
              <span class="label">Valor Atual:</span>
              <span class="value">{{ formatCurrency(getTotalValorAtualForGroup(group.positions)) }}</span>
              <span class="label">Participação:</span>
              <span class="value">{{ getPercentageForGroup(group.positions).toFixed(2) }}%</span>
            </div>
          </div>
        </div>
        <div class="table-container">
          <table class="positions-table">
            <thead>
              <tr>
                <th>Título</th>
                <th>Quantidade</th>
                <th>Preço Médio</th>
                <th>Valor Total Investido</th>
                <th>Preço Atual</th>
                <th>Valor Atual</th>
                <th>Lucro</th>
              </tr>
            </thead>
            <tbody>
              @for (position of group.positions; track position.titulo) {
              <tr>
                <td>{{ position.titulo }}</td>
                <td>{{ position.quantidadeTotal }}</td>
                <td>{{ formatCurrency(position.precoMedioPonderado) }}</td>
                <td>{{ formatCurrency(position.valorTotalInvestido) }}</td>
                <td>{{ position.currentPrice !== undefined ? formatCurrency(position.currentPrice) : 'N/A' }}</td>
                <td>{{ position.valorAtual !== undefined ? formatCurrency(position.valorAtual) : 'N/A' }}</td>
                <td [class.positive]="(position.totalLucro || 0) > 0" [class.negative]="(position.totalLucro || 0) < 0">
                  {{ formatCurrency(position.totalLucro || 0) }}
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }
    }
  </section>
  }

  <!-- Renda Fixa Tab Content -->
  @if (activeTab === 'renda-fixa') {
  <app-fixed-income-list [userId]="userId" />
  }

  <!-- Histórico Tab Content -->
  @if (activeTab === 'historico') {
  <div class="history-section">
    <div class="section-header-with-action">
      <h3>Histórico de Notas de Corretagem</h3>
      <app-upload-pdf [clientId]="userId!" (operationsAdded)="onOperationsAdded($event)" />
    </div>
    <app-history-list #historyList [userId]="userId" />
  </div>
  }

  <!-- Estratégia de Alocação Tab Content -->
  @if (activeTab === 'allocation-strategy') {
  <app-allocation-strategy [userId]="userId" />
  }

  <!-- Crypto Tab Content -->
  @if (activeTab === 'crypto') {
  <app-crypto [userId]="userId!" />
  }

  <!-- FIIs Tab Content -->
  @if (activeTab === 'fiis') {
  <app-fiis-list [userId]="userId" />
  }
</div>
} @else {
<p class="no-selection">Selecione um cliente para ver sua carteira.</p>
}