<div class="clubedovalor-app">
  <!-- Error Message -->
  @if (error) {
    <div class="alert alert-error">
      <svg class="icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
        <circle cx="10" cy="10" r="9" stroke="currentColor" stroke-width="1.5"/>
        <path d="M10 6v4M10 14h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span>{{ error }}</span>
    </div>
  }

  <!-- Left Sidebar - Month Selection (like user-list) -->
  <aside class="month-sidebar">
    <div class="sidebar-header">
      <h3>Clube do Valor</h3>
    </div>
    <nav class="month-list">
      @for (month of getMonths(); track month.key) {
        <button 
          class="month-item"
          [class.active]="selectedMonth === month.key"
          (click)="selectMonth(month.key)"
        >
          <span class="month-label">{{ month.label }}</span>
          @if (selectedMonth === month.key) {
            <svg class="check-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M13 4L6 11L3 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          }
        </button>
      }
    </nav>
  </aside>

  <!-- Right Content Area - Table -->
  <main class="content-area">
    <!-- Strategy Selector Menu -->
    <div class="strategy-selector">
      @for (strategy of strategies; track strategy.code) {
        <button 
          class="strategy-button"
          [class.active]="selectedStrategy === strategy.code"
          (click)="selectStrategy(strategy.code)"
        >
          <span class="strategy-label">{{ strategy.label }}</span>
          <span class="strategy-name">{{ strategy.fullName }}</span>
        </button>
      }
    </div>

    <!-- Content Header - Always visible -->
    <div class="content-header">
      <div class="header-title">
        <h2>{{ getCurrentStrategyLabel() }} - {{ getCurrentMonthLabel() }}</h2>
        <p>Recomendações Mensais</p>
      </div>
      <div class="header-actions">
        <button class="menu-button" (click)="refreshFromSheets()" [disabled]="loading">
          <svg class="icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M8 2v4l3-3M8 14v-4l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M2 8a6 6 0 0 1 6-6M14 8a6 6 0 0 1-6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <span>{{ loading ? 'Atualizando...' : 'Atualizar' }}</span>
        </button>
        @if (timestamp) {
          <span class="timestamp">
            <svg class="icon" width="14" height="14" viewBox="0 0 14 14" fill="none">
              <circle cx="7" cy="7" r="6" stroke="currentColor" stroke-width="1.5"/>
              <path d="M7 4v3l2 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Última atualização: {{ formatDate(timestamp) }}
          </span>
        }
      </div>
    </div>

    <!-- Content Body -->
    @if (loading && stocks.length === 0) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Carregando dados...</p>
      </div>
    } @else if (filteredStocks.length > 0) {
      <!-- AMBB1 Table -->
      @if (selectedStrategy === 'AMBB1') {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="col-rank sortable" [class.active]="sortField === 'ranking'" (click)="selectSortField('ranking')">
                  <span>Ranking</span>
                  <span class="sort-icon">{{ getSortIcon('ranking') }}</span>
                </th>
                <th class="col-code sortable" [class.active]="sortField === 'codigo'" (click)="selectSortField('codigo')">
                  <span>Código</span>
                  <span class="sort-icon">{{ getSortIcon('codigo') }}</span>
                </th>
                <th class="col-yield sortable" [class.active]="sortField === 'earningYield'" (click)="selectSortField('earningYield')">
                  <span>Earning Yield</span>
                  <span class="sort-icon">{{ getSortIcon('earningYield') }}</span>
                </th>
                <th class="col-name sortable" [class.active]="sortField === 'nome'" (click)="selectSortField('nome')">
                  <span>Nome</span>
                  <span class="sort-icon">{{ getSortIcon('nome') }}</span>
                </th>
                <th class="col-sector sortable" [class.active]="sortField === 'setor'" (click)="selectSortField('setor')">
                  <span>Setor</span>
                  <span class="sort-icon">{{ getSortIcon('setor') }}</span>
                </th>
                <th class="col-ev sortable" [class.active]="sortField === 'ev'" (click)="selectSortField('ev')">
                  <span>EV</span>
                  <span class="sort-icon">{{ getSortIcon('ev') }}</span>
                </th>
                <th class="col-ebit sortable" [class.active]="sortField === 'ebit'" (click)="selectSortField('ebit')">
                  <span>Ebit</span>
                  <span class="sort-icon">{{ getSortIcon('ebit') }}</span>
                </th>
                <th class="col-liquidity sortable" [class.active]="sortField === 'liquidez'" (click)="selectSortField('liquidez')">
                  <span>Liquidez</span>
                  <span class="sort-icon">{{ getSortIcon('liquidez') }}</span>
                </th>
                <th class="col-price sortable" [class.active]="sortField === 'cotacaoAtual'" (click)="selectSortField('cotacaoAtual')">
                  <span>Cotação</span>
                  <span class="sort-icon">{{ getSortIcon('cotacaoAtual') }}</span>
                </th>
                <th class="col-notes">Observação</th>
                <th class="col-actions">Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (stock of filteredStocks; track stock.codigo) {
                <tr>
                    <td class="col-rank">{{ stock.ranking }}</td>
                    <td class="col-code">
                      <span class="code-badge">{{ stock.codigo }}</span>
                    </td>
                    <td class="col-yield">
                      <span class="value-positive">{{ formatPercentage(getStockField(stock, 'earningYield')) }}</span>
                    </td>
                    <td class="col-name">{{ stock.nome }}</td>
                    <td class="col-sector">{{ stock.setor }}</td>
                    <td class="col-ev">{{ formatCurrency(getStockField(stock, 'ev')) }}</td>
                    <td class="col-ebit">{{ formatCurrency(getStockField(stock, 'ebit')) }}</td>
                    <td class="col-liquidity">{{ formatCurrency(getStockField(stock, 'liquidez')) }}</td>
                    <td class="col-price">{{ formatCurrency(getStockField(stock, 'cotacaoAtual')) }}</td>
                    <td class="col-notes">{{ stock.observacao }}</td>
                    <td class="col-actions">
                      <button 
                        class="action-button" 
                        (click)="deleteStock(stock)"
                        [disabled]="loading"
                        title="Remover ação"
                      >
                        <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                          <path d="M10 4L4 10M4 4l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                        </svg>
                      </button>
                    </td>
                  </tr>
              }
            </tbody>
          </table>
        </div>
      }
      
      <!-- AMBB2 Table -->
      @if (selectedStrategy === 'AMBB2') {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="col-rank sortable" [class.active]="sortField === 'ranking'" (click)="selectSortField('ranking')">
                  <span>Ranking</span>
                  <span class="sort-icon">{{ getSortIcon('ranking') }}</span>
                </th>
                <th class="col-code sortable" [class.active]="sortField === 'codigo'" (click)="selectSortField('codigo')">
                  <span>Código</span>
                  <span class="sort-icon">{{ getSortIcon('codigo') }}</span>
                </th>
                <th class="col-valueidx sortable" [class.active]="sortField === 'valueIdx'" (click)="selectSortField('valueIdx')">
                  <span>Value IDX</span>
                  <span class="sort-icon">{{ getSortIcon('valueIdx') }}</span>
                </th>
                <th class="col-name sortable" [class.active]="sortField === 'nome'" (click)="selectSortField('nome')">
                  <span>Nome</span>
                  <span class="sort-icon">{{ getSortIcon('nome') }}</span>
                </th>
                <th class="col-sector sortable" [class.active]="sortField === 'setor'" (click)="selectSortField('setor')">
                  <span>Setor</span>
                  <span class="sort-icon">{{ getSortIcon('setor') }}</span>
                </th>
                <th class="col-yield sortable" [class.active]="sortField === 'earningYield'" (click)="selectSortField('earningYield')">
                  <span>EY</span>
                  <span class="sort-icon">{{ getSortIcon('earningYield') }}</span>
                </th>
                <th class="col-cfy sortable" [class.active]="sortField === 'cfy'" (click)="selectSortField('cfy')">
                  <span>CFY</span>
                  <span class="sort-icon">{{ getSortIcon('cfy') }}</span>
                </th>
                <th class="col-btm sortable" [class.active]="sortField === 'btm'" (click)="selectSortField('btm')">
                  <span>BtM</span>
                  <span class="sort-icon">{{ getSortIcon('btm') }}</span>
                </th>
                <th class="col-mktcap sortable" [class.active]="sortField === 'mktcap'" (click)="selectSortField('mktcap')">
                  <span>MktCap</span>
                  <span class="sort-icon">{{ getSortIcon('mktcap') }}</span>
                </th>
                <th class="col-ev sortable" [class.active]="sortField === 'ev'" (click)="selectSortField('ev')">
                  <span>EV</span>
                  <span class="sort-icon">{{ getSortIcon('ev') }}</span>
                </th>
                <th class="col-liquidity sortable" [class.active]="sortField === 'liquidez'" (click)="selectSortField('liquidez')">
                  <span>Liquidez (3M)</span>
                  <span class="sort-icon">{{ getSortIcon('liquidez') }}</span>
                </th>
                <th class="col-price sortable" [class.active]="sortField === 'cotacaoAtual'" (click)="selectSortField('cotacaoAtual')">
                  <span>Cotação</span>
                  <span class="sort-icon">{{ getSortIcon('cotacaoAtual') }}</span>
                </th>
                <th class="col-notes">Observação</th>
                <th class="col-actions">Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (stock of filteredStocks; track stock.codigo) {
                <tr>
                  <td class="col-rank">{{ stock.ranking }}</td>
                  <td class="col-code">
                    <span class="code-badge">{{ stock.codigo }}</span>
                  </td>
                  <td class="col-valueidx">{{ formatValueIdx(stock) }}</td>
                  <td class="col-name">{{ stock.nome }}</td>
                  <td class="col-sector">{{ stock.setor }}</td>
                  <td class="col-yield">
                    <span class="value-positive">{{ formatPercentage(getStockField(stock, 'earningYield')) }}</span>
                  </td>
                  <td class="col-cfy">
                    @if (getStockField(stock, 'cfy') > 0 && getStockField(stock, 'cfy') < 100) {
                      <span class="value-positive">{{ formatPercentage(getStockField(stock, 'cfy')) }}</span>
                    } @else {
                      <span>{{ formatCurrency(getStockField(stock, 'cfy')) }}</span>
                    }
                  </td>
                  <td class="col-btm">{{ formatCurrency(getStockField(stock, 'btm')) }}</td>
                  <td class="col-mktcap">{{ formatCurrency(getStockField(stock, 'mktcap')) }}</td>
                  <td class="col-ev">{{ formatCurrency(getStockField(stock, 'ev')) }}</td>
                  <td class="col-liquidity">{{ formatCurrency(getStockField(stock, 'liquidez')) }}</td>
                  <td class="col-price">{{ formatCurrency(getStockField(stock, 'cotacaoAtual')) }}</td>
                  <td class="col-notes">{{ stock.observacao }}</td>
                  <td class="col-actions">
                    <button 
                      class="action-button" 
                      (click)="deleteStock(stock)"
                      [disabled]="loading"
                      title="Remover ação"
                    >
                      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M10 4L4 10M4 4l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      
      <!-- MDIV Table -->
      @if (selectedStrategy === 'MDIV') {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="col-rank sortable" [class.active]="sortField === 'ranking'" (click)="selectSortField('ranking')">
                  <span>Ranking</span>
                  <span class="sort-icon">{{ getSortIcon('ranking') }}</span>
                </th>
                <th class="col-code sortable" [class.active]="sortField === 'codigo'" (click)="selectSortField('codigo')">
                  <span>Código</span>
                  <span class="sort-icon">{{ getSortIcon('codigo') }}</span>
                </th>
                <th class="col-dividend sortable" [class.active]="sortField === 'dividendYield36m'" (click)="selectSortField('dividendYield36m')">
                  <span>Dividend Yield (36 meses)</span>
                  <span class="sort-icon">{{ getSortIcon('dividendYield36m') }}</span>
                </th>
                <th class="col-name sortable" [class.active]="sortField === 'nome'" (click)="selectSortField('nome')">
                  <span>Nome</span>
                  <span class="sort-icon">{{ getSortIcon('nome') }}</span>
                </th>
                <th class="col-sector sortable" [class.active]="sortField === 'setor'" (click)="selectSortField('setor')">
                  <span>Setor</span>
                  <span class="sort-icon">{{ getSortIcon('setor') }}</span>
                </th>
                <th class="col-liquidity sortable" [class.active]="sortField === 'liquidezMedia3m'" (click)="selectSortField('liquidezMedia3m')">
                  <span>Liquidez Média 3M</span>
                  <span class="sort-icon">{{ getSortIcon('liquidezMedia3m') }}</span>
                </th>
                <th class="col-actions">Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (stock of filteredStocks; track stock.codigo) {
                <tr>
                  <td class="col-rank">{{ stock.ranking }}</td>
                  <td class="col-code">
                    <span class="code-badge">{{ stock.codigo }}</span>
                  </td>
                  <td class="col-dividend">
                    <span class="value-positive">{{ formatPercentage(getDividendYield(stock)) }}</span>
                  </td>
                  <td class="col-name">{{ stock.nome }}</td>
                  <td class="col-sector">{{ stock.setor }}</td>
                  <td class="col-liquidity">{{ formatCurrency(getLiquidezMedia(stock)) }}</td>
                  <td class="col-actions">
                    <button 
                      class="action-button" 
                      (click)="deleteStock(stock)"
                      [disabled]="loading"
                      title="Remover ação"
                    >
                      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M10 4L4 10M4 4l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      
      <!-- MOMM Table -->
      @if (selectedStrategy === 'MOMM') {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="col-rank sortable" [class.active]="sortField === 'ranking'" (click)="selectSortField('ranking')">
                  <span>Ranking</span>
                  <span class="sort-icon">{{ getSortIcon('ranking') }}</span>
                </th>
                <th class="col-code sortable" [class.active]="sortField === 'codigo'" (click)="selectSortField('codigo')">
                  <span>Código</span>
                  <span class="sort-icon">{{ getSortIcon('codigo') }}</span>
                </th>
                <th class="col-momentum sortable" [class.active]="sortField === 'momentum6m'" (click)="selectSortField('momentum6m')">
                  <span>6 months Mom(%)</span>
                  <span class="sort-icon">{{ getSortIcon('momentum6m') }}</span>
                </th>
                <th class="col-idratio sortable" [class.active]="sortField === 'idRatio'" (click)="selectSortField('idRatio')">
                  <span>ID ratio</span>
                  <span class="sort-icon">{{ getSortIcon('idRatio') }}</span>
                </th>
                <th class="col-name sortable" [class.active]="sortField === 'nome'" (click)="selectSortField('nome')">
                  <span>Nome</span>
                  <span class="sort-icon">{{ getSortIcon('nome') }}</span>
                </th>
                <th class="col-sector sortable" [class.active]="sortField === 'setor'" (click)="selectSortField('setor')">
                  <span>Setor</span>
                  <span class="sort-icon">{{ getSortIcon('setor') }}</span>
                </th>
                <th class="col-subsetor sortable" [class.active]="sortField === 'subsetor'" (click)="selectSortField('subsetor')">
                  <span>Subsetor</span>
                  <span class="sort-icon">{{ getSortIcon('subsetor') }}</span>
                </th>
                <th class="col-segmento sortable" [class.active]="sortField === 'segmento'" (click)="selectSortField('segmento')">
                  <span>Segmento</span>
                  <span class="sort-icon">{{ getSortIcon('segmento') }}</span>
                </th>
                <th class="col-volume sortable" [class.active]="sortField === 'volumeMm'" (click)="selectSortField('volumeMm')">
                  <span>Volume(MM)</span>
                  <span class="sort-icon">{{ getSortIcon('volumeMm') }}</span>
                </th>
                <th class="col-capitalizacao sortable" [class.active]="sortField === 'capitalizacaoMm'" (click)="selectSortField('capitalizacaoMm')">
                  <span>Capitalização (MM)</span>
                  <span class="sort-icon">{{ getSortIcon('capitalizacaoMm') }}</span>
                </th>
                <th class="col-actions">Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (stock of filteredStocks; track stock.codigo) {
                <tr>
                  <td class="col-rank">{{ stock.ranking }}</td>
                  <td class="col-code">
                    <span class="code-badge">{{ stock.codigo }}</span>
                  </td>
                  <td class="col-momentum">
                    <span [class.value-positive]="getStockField(stock, 'momentum6m') > 0" [class.value-negative]="getStockField(stock, 'momentum6m') < 0">
                      {{ formatPercentage(getStockField(stock, 'momentum6m')) }}
                    </span>
                  </td>
                  <td class="col-idratio">{{ formatDecimal(getStockField(stock, 'idRatio'), 2) }}</td>
                  <td class="col-name">{{ stock.nome }}</td>
                  <td class="col-sector">{{ stock.setor }}</td>
                  <td class="col-subsetor">{{ getStockStringField(stock, 'subsetor') || '-' }}</td>
                  <td class="col-segmento">{{ getStockStringField(stock, 'segmento') || '-' }}</td>
                  <td class="col-volume">{{ formatCurrency(getStockField(stock, 'volumeMm')) }}</td>
                  <td class="col-capitalizacao">{{ formatCurrency(getStockField(stock, 'capitalizacaoMm')) }}</td>
                  <td class="col-actions">
                    <button class="action-button" (click)="deleteStock(stock)" [disabled]="loading" title="Remover ação">
                      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M10 4L4 10M4 4l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      
      <!-- MOMP Table -->
      @if (selectedStrategy === 'MOMP') {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th class="col-rank sortable" [class.active]="sortField === 'ranking'" (click)="selectSortField('ranking')">
                  <span>Ranking</span>
                  <span class="sort-icon">{{ getSortIcon('ranking') }}</span>
                </th>
                <th class="col-code sortable" [class.active]="sortField === 'codigo'" (click)="selectSortField('codigo')">
                  <span>Código</span>
                  <span class="sort-icon">{{ getSortIcon('codigo') }}</span>
                </th>
                <th class="col-momentum sortable" [class.active]="sortField === 'momentum6m'" (click)="selectSortField('momentum6m')">
                  <span>6 months Mom(%)</span>
                  <span class="sort-icon">{{ getSortIcon('momentum6m') }}</span>
                </th>
                <th class="col-idratio sortable" [class.active]="sortField === 'idRatio'" (click)="selectSortField('idRatio')">
                  <span>ID ratio</span>
                  <span class="sort-icon">{{ getSortIcon('idRatio') }}</span>
                </th>
                <th class="col-name sortable" [class.active]="sortField === 'nome'" (click)="selectSortField('nome')">
                  <span>Nome</span>
                  <span class="sort-icon">{{ getSortIcon('nome') }}</span>
                </th>
                <th class="col-sector sortable" [class.active]="sortField === 'setor'" (click)="selectSortField('setor')">
                  <span>Setor</span>
                  <span class="sort-icon">{{ getSortIcon('setor') }}</span>
                </th>
                <th class="col-subsetor sortable" [class.active]="sortField === 'subsetor'" (click)="selectSortField('subsetor')">
                  <span>Subsetor</span>
                  <span class="sort-icon">{{ getSortIcon('subsetor') }}</span>
                </th>
                <th class="col-segmento sortable" [class.active]="sortField === 'segmento'" (click)="selectSortField('segmento')">
                  <span>Segmento</span>
                  <span class="sort-icon">{{ getSortIcon('segmento') }}</span>
                </th>
                <th class="col-volume sortable" [class.active]="sortField === 'volumeMm'" (click)="selectSortField('volumeMm')">
                  <span>Volume(MM)</span>
                  <span class="sort-icon">{{ getSortIcon('volumeMm') }}</span>
                </th>
                <th class="col-capitalizacao sortable" [class.active]="sortField === 'capitalizacaoMm'" (click)="selectSortField('capitalizacaoMm')">
                  <span>Capitalização (MM)</span>
                  <span class="sort-icon">{{ getSortIcon('capitalizacaoMm') }}</span>
                </th>
                <th class="col-actions">Ações</th>
              </tr>
            </thead>
            <tbody>
              @for (stock of filteredStocks; track stock.codigo) {
                <tr>
                  <td class="col-rank">{{ stock.ranking }}</td>
                  <td class="col-code">
                    <span class="code-badge">{{ stock.codigo }}</span>
                  </td>
                  <td class="col-momentum">
                    <span [class.value-positive]="getStockField(stock, 'momentum6m') > 0" [class.value-negative]="getStockField(stock, 'momentum6m') < 0">
                      {{ formatPercentage(getStockField(stock, 'momentum6m')) }}
                    </span>
                  </td>
                  <td class="col-idratio">{{ formatDecimal(getStockField(stock, 'idRatio'), 2) }}</td>
                  <td class="col-name">{{ stock.nome }}</td>
                  <td class="col-sector">{{ stock.setor }}</td>
                  <td class="col-subsetor">{{ getStockStringField(stock, 'subsetor') || '-' }}</td>
                  <td class="col-segmento">{{ getStockStringField(stock, 'segmento') || '-' }}</td>
                  <td class="col-volume">{{ formatCurrency(getStockField(stock, 'volumeMm')) }}</td>
                  <td class="col-capitalizacao">{{ formatCurrency(getStockField(stock, 'capitalizacaoMm')) }}</td>
                  <td class="col-actions">
                    <button class="action-button" (click)="deleteStock(stock)" [disabled]="loading" title="Remover ação">
                      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                        <path d="M10 4L4 10M4 4l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
      <div class="table-footer">
        <span>{{ filteredStocks.length }} {{ filteredStocks.length === 1 ? 'ação' : 'ações' }}</span>
      </div>
    } @else {
      <div class="empty-state">
        <svg class="empty-icon" width="64" height="64" viewBox="0 0 64 64" fill="none">
          <circle cx="32" cy="32" r="30" stroke="currentColor" stroke-width="2" stroke-dasharray="4 4"/>
          <path d="M32 20v24M20 32h24" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <h3>Nenhuma ação disponível</h3>
        <p>Selecione um mês para visualizar os dados.</p>
      </div>
    }
  </main>
</div>
