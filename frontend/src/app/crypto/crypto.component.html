<div class="crypto-container">
  <div class="crypto-header">
    <h2>Criptomoedas</h2>
  </div>

  <!-- Positions Summary -->
  @if (userId && positions.length > 0) {
    <div class="summary-section">
      <h3>Posições Atuais</h3>
      <div class="summary-cards">
        <div class="summary-card">
          <span class="label">Total Investido:</span>
          <span class="value">{{ formatCurrency(getTotalInvested()) }}</span>
        </div>
        <div class="summary-card">
          <span class="label">Valor Atual:</span>
          <span class="value">{{ formatCurrency(getTotalCurrentValue()) }}</span>
        </div>
        <div class="summary-card">
          <span class="label">Ganho/Perda:</span>
          <span class="value" [class.positive]="getTotalGainLoss() >= 0" [class.negative]="getTotalGainLoss() < 0">
            {{ formatCurrency(getTotalGainLoss()) }} ({{ getTotalGainLossPercent().toFixed(2) }}%)
          </span>
        </div>
        <div class="summary-card">
          <span class="label">Criptomoedas na Carteira:</span>
          <span class="value">{{ positions.length }}</span>
        </div>
      </div>
      
      <table class="positions-table">
        <thead>
          <tr>
            <th>Moeda</th>
            <th>Quantidade</th>
            <th>Preço Médio</th>
            <th>Preço Atual</th>
            <th>Valor Investido</th>
            <th>Valor Atual</th>
            <th>Ganho/Perda</th>
            <th>Corretora</th>
          </tr>
        </thead>
        <tbody>
          @for (position of positions; track position.id) {
            @let investedValue = position.quantity * position.average_price;
            @let currentValue = position.current_value || 0;
            @let gainLoss = currentValue - investedValue;
            @let gainLossPercent = investedValue > 0 ? ((gainLoss / investedValue) * 100) : 0;
            <tr>
              <td><strong>{{ position.crypto_currency.symbol }}</strong> - {{ position.crypto_currency.name }}</td>
              <td>{{ position.quantity }}</td>
              <td>{{ formatCurrency(position.average_price) }}</td>
              <td>
                @if (position.current_price !== undefined) {
                  {{ formatCurrency(position.current_price) }}
                } @else {
                  <span class="loading-price">Carregando...</span>
                }
              </td>
              <td>{{ formatCurrency(investedValue) }}</td>
              <td>
                @if (position.current_value !== undefined) {
                  {{ formatCurrency(position.current_value) }}
                } @else {
                  <span class="loading-price">-</span>
                }
              </td>
              <td>
                @if (position.current_value !== undefined) {
                  <span [class.positive]="gainLoss >= 0" [class.negative]="gainLoss < 0">
                    {{ formatCurrency(gainLoss) }} ({{ gainLossPercent.toFixed(2) }}%)
                  </span>
                } @else {
                  <span class="loading-price">-</span>
                }
              </td>
              <td>{{ position.broker || '-' }}</td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Operations Section -->
  @if (userId) {
    <div class="operations-section">
      <div class="section-header">
        <h3>Operações</h3>
        <button class="btn-primary" (click)="onCreateOperation()">Nova Operação</button>
      </div>
      
      @if (operations.length > 0) {
        <table class="operations-table">
          <thead>
            <tr>
              <th>Data</th>
              <th>Moeda</th>
              <th>Tipo</th>
              <th>Quantidade</th>
              <th>Preço</th>
              <th>Valor Total</th>
              <th>Corretora</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            @for (operation of operations; track operation.id) {
              <tr>
                <td>{{ formatDate(operation.operation_date) }}</td>
                <td><strong>{{ operation.crypto_currency.symbol }}</strong></td>
                <td>{{ operation.operation_type === 'BUY' ? 'Compra' : 'Venda' }}</td>
                <td>{{ operation.quantity }}</td>
                <td>{{ formatCurrency(operation.price) }}</td>
                <td>{{ formatCurrency(operation.total_value) }}</td>
                <td>{{ operation.broker || '-' }}</td>
                <td>
                  <div class="action-buttons">
                    <button class="btn-icon" (click)="onEditOperation(operation)" title="Editar">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M11.333 2a2.828 2.828 0 1 1 4 4L6 15.333H2v-4L11.333 2z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                    <button class="btn-icon btn-danger" (click)="onDeleteOperation(operation)" title="Excluir">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M2 4h12M6 4V2a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v2M6 7.333v4M10 7.333v4M3.333 4l.667 9.333a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1L12.667 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      } @else {
        <p class="empty-message">Nenhuma operação cadastrada.</p>
      }
    </div>
  }


  <!-- Operation Dialog -->
  @if (showOperationDialog) {
    <app-crypto-operation-dialog
      [userId]="userId"
      [operation]="editingOperation"
      [currencies]="currencies"
      (saved)="onOperationSaved()"
      (canceled)="onOperationCanceled()"
    />
  }
</div>

