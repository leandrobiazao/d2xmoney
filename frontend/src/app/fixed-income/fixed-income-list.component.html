<div class="fixed-income-list-container">
  <!-- Hidden file input -->
  <input 
    type="file" 
    accept=".xlsx,.xls" 
    #fileInput 
    (change)="onFileSelected($event)" 
    style="display: none;"
  />

  <div class="header-section">
    <h2>Renda Fixa</h2>
    <button 
      class="btn-import" 
      (click)="onImportClick()" 
      [disabled]="isImporting || !userId"
    >
      @if (isImporting) {
        Importando...
      } @else {
        Importar Portfólio
      }
    </button>
  </div>

  <!-- Import Result/Error Messages -->
  @if (importResult && (!importResult.errors || importResult.errors.length === 0) && (importResult.created > 0 || importResult.updated > 0)) {
    <div class="import-notification success">
      <div class="notification-content">
        <strong>Importação concluída com sucesso!</strong>
        <div class="import-stats">
          <span>Criados: {{ importResult.created }}</span>
          <span>Atualizados: {{ importResult.updated }}</span>
          @if (importResult.cdb_count !== undefined) {
            <span>CDBs: {{ importResult.cdb_count }}</span>
          }
          @if (importResult.tesouro_count !== undefined) {
            <span>Tesouro Direto: {{ importResult.tesouro_count }}</span>
          }
          @if (importResult.caixa_count !== undefined) {
            <span>CAIXA: {{ importResult.caixa_count }}</span>
          }
        </div>
      </div>
      <button class="btn-dismiss" (click)="dismissImportMessage()">×</button>
    </div>
  }

  @if (importErrorMessage) {
    <div class="import-notification error">
      <div class="notification-content">
        <strong>Erro na importação</strong>
        <pre>{{ importErrorMessage }}</pre>
      </div>
      <button class="btn-dismiss" (click)="dismissImportMessage()">×</button>
    </div>
  }

  <!-- Summary Cards -->
  @if (!isLoading && groupedPositions.length > 0) {
    <div class="summary-cards">
      <div class="summary-card">
        <span class="label">Total Investido:</span>
        <span class="value">{{ formatCurrency(getTotalInvestido()) }}</span>
      </div>
      <div class="summary-card">
        <span class="label">Valor Atual:</span>
        <span class="value">{{ formatCurrency(getValorAtual()) }}</span>
      </div>
      <div class="summary-card">
        <span class="label">Ativos na Carteira:</span>
        <span class="value">{{ getActivePositionsCount() }}</span>
      </div>
    </div>
  }

  @if (isLoading) {
    <div class="loading-state">
      <p>Carregando posições...</p>
    </div>
  } @else if (errorMessage) {
    <div class="error-state">
      <p>{{ errorMessage }}</p>
    </div>
  } @else if (groupedPositions.length === 0) {
    <div class="empty-state">
      <p>Nenhuma posição de Renda Fixa encontrada.</p>
    </div>
  } @else {
    <!-- Grouped Positions -->
    @for (group of groupedPositions; track group.type) {
        <div class="group-section">
          @if (group.isTesouroDireto && group.subTypeGroups) {
            <!-- Tesouro Direto with sub-type grouping -->
            @for (subTypeGroup of group.subTypeGroups; track subTypeGroup.subTypeName) {
              <div class="subtype-section">
                <div class="subtype-header">
                  <h4>{{ subTypeGroup.percentage.toFixed(1) }}% | {{ subTypeGroup.subTypeName }}</h4>
                </div>
                
                <div class="positions-table">
                  <table>
                    <thead>
                      <tr>
                        <th>Tipo</th>
                        <th>Ativo</th>
                        <th>Posição</th>
                        <th>%</th>
                        <th>% Alocação</th>
                        <th>Total aplicado</th>
                        <th>Qtd.</th>
                        <th>Disponível</th>
                        <th>Vencimento</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (position of subTypeGroup.positions; track position.id) {
                          <tr (click)="selectPosition(position)" class="position-row">
                            <td>
                              <strong>{{ getSubtypeName(position) }}</strong>
                            </td>
                            <td>
                              <strong>{{ position.asset_name }}</strong>
                            </td>
                            <td>{{ formatCurrency(position.position_value) }}</td>
                            <td>{{ getSubtypePercentage(position).toFixed(2) }}%</td>
                            <td>
                              @if (subTypeGroup.totalValue > 0) {
                                {{ ((getPositionValue(position.position_value) / subTypeGroup.totalValue) * 100).toFixed(2) }}%
                              } @else {
                                -
                              }
                            </td>
                            <td>{{ formatCurrency(position.applied_value) }}</td>
                            <td>{{ position.quantity }}</td>
                            <td>{{ position.available_quantity }}</td>
                            <td>{{ formatDate(position.maturity_date) }}</td>
                          </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            }
          } @else {
            <!-- Other fixed income (CDB, etc.) -->
            <div class="positions-table">
              <table>
                <thead>
                  <tr>
                    <th>Tipo</th>
                    <th>Ativo</th>
                    <th>Aplicação</th>
                    <th>Vencimento</th>
                    <th>Taxa</th>
                    <th>Quantidade</th>
                    <th>Valor Aplicado</th>
                    <th>Posição</th>
                    <th>Valor Líquido</th>
                    <th>%</th>
                  </tr>
                </thead>
                <tbody>
                  @for (position of group.positions; track position.id) {
                        <tr (click)="selectPosition(position)" class="position-row">
                          <td>
                            <strong>{{ getSubtypeName(position) }}</strong>
                          </td>
                          <td>
                            <strong>{{ position.asset_name }}</strong>
                          </td>
                          @if (isCaixaPosition(position)) {
                            <!-- CAIXA: Only show Posição, Valor Líquido, and % -->
                            <td colspan="5"></td>
                            <td>{{ formatCurrency(position.position_value) }}</td>
                            <td>{{ formatCurrency(position.net_value) }}</td>
                            <td>{{ getSubtypePercentage(position).toFixed(2) }}%</td>
                          } @else {
                            <!-- Regular positions: Show all columns -->
                            <td>{{ formatDate(position.application_date) }}</td>
                            <td>{{ formatDate(position.maturity_date) }}</td>
                            <td>{{ position.rate || '-' }}</td>
                            <td>{{ position.quantity }}</td>
                            <td>{{ formatCurrency(position.applied_value) }}</td>
                            <td>{{ formatCurrency(position.position_value) }}</td>
                            <td>{{ formatCurrency(position.net_value) }}</td>
                            <td>{{ getSubtypePercentage(position).toFixed(2) }}%</td>
                          }
                        </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
    }
  }

  <!-- Detail Modal -->
  @if (selectedPosition) {
    <div class="modal-overlay" (click)="closeDetail()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>
            @if (selectedPosition.investment_type_name && selectedPosition.investment_sub_type_name) {
              {{ selectedPosition.investment_type_name }} - {{ selectedPosition.investment_sub_type_name }}
            } @else if (selectedPosition.investment_type_name) {
              {{ selectedPosition.investment_type_name }}
            } @else {
              Detalhes de Renda Fixa
            }
          </h3>
          <button class="btn-close" (click)="closeDetail()">×</button>
        </div>
        <div class="modal-body">
          <app-fixed-income-detail [position]="selectedPosition" />
        </div>
      </div>
    </div>
  }
</div>

