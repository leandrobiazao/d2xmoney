<div class="allocation-strategy-app">
  <!-- Sidebar (only shown when userId is not provided) -->
  @if (!userId) {
  <aside class="user-sidebar">
    <div class="sidebar-header">
      <h2>Estratégia de Alocação</h2>
      <p>Selecione um usuário para configurar sua estratégia</p>
    </div>

    @if (isLoading) {
      <div class="sidebar-fallback">
        <p>Carregando usuários...</p>
      </div>
    } @else if (users.length === 0) {
      <div class="sidebar-fallback">
        <p>Nenhum usuário cadastrado.</p>
      </div>
    } @else {
      <div class="user-grid">
        @for (user of users; track user.id) {
          <app-user-item
            [user]="user"
            [selected]="selectedUser?.id === user.id"
            (select)="onUserSelected($event)"
          />
        }
      </div>
    }
  </aside>
  }

  <!-- Content -->
  <section class="content-area">
    @if (isLoadingStrategy) {
      <div class="status-card">
        <p>Carregando estratégia de alocação...</p>
      </div>
    } @else if (!selectedUser) {
      <div class="fallback-message">
        <p>Selecione um usuário para visualizar a estratégia.</p>
      </div>
    } @else if (errorMessage) {
      <div class="error-card">
        <p>{{ errorMessage }}</p>
        <button class="btn btn-primary" (click)="loadStrategy(selectedUser.id)">Tentar novamente</button>
      </div>
    } @else {
      <div class="strategy-content">
        <!-- Tabs -->
        <div class="tabs-container">
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'configuration'"
            (click)="onTabChange('configuration')"
          >
            Configuração
          </button>
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'rebalancing'"
            (click)="onTabChange('rebalancing')"
          >
            Rebalanceamento
          </button>
        </div>

        <!-- Configuration Tab -->
        @if (activeTab === 'configuration') {
          @if (strategy || draftTypeAllocations.length > 0) {
            @if (draftTypeAllocations.length > 0) {
            <section class="allocations-panel">
              <h4>Alocações por tipo</h4>
              <div class="validation-banner" [class.invalid]="!isTypeTotalValid">
                <span>Total: {{ typeAllocationTotal | number:'1.0-2' }}%</span>
                @if (!isTypeTotalValid) {
                  <span>As alocações por tipo precisam somar 100%</span>
                }
              </div>
              <div class="allocations-list">
                @for (typeAlloc of draftTypeAllocations; track typeAlloc.id || typeAlloc.investment_type.id; let typeIndex = $index) {
                  <article class="allocation-card">
                    <div class="allocation-header">
                      <div>
                        <p class="eyebrow">Tipo</p>
                        <h5>{{ typeAlloc.investment_type.name }}</h5>
                      </div>
                      <div class="percentage-input">
                        <input
                          type="number"
                          min="0"
                          max="100"
                          step="0.1"
                          [ngModel]="typeAlloc.target_percentage"
                          (ngModelChange)="onTypePercentageChange(typeIndex, $event)"
                        />
                        <span>%</span>
                      </div>
                    </div>

                    @if (getSubTypesForInvestmentType(typeAlloc.investment_type_id).length > 0) {
                      <div class="sub-allocations">
                        <div class="validation-banner small" [class.invalid]="!isSubTypeTotalValid(typeAlloc)">
                          <span>Total por subtipo: {{ getSubTypeTotal(typeAlloc) | number:'1.0-2' }}% / {{ typeAlloc.target_percentage | number:'1.0-2' }}%</span>
                          @if (!isSubTypeTotalValid(typeAlloc)) {
                            <span>Os subtipos precisam somar {{ typeAlloc.target_percentage | number:'1.0-2' }}% (mesmo valor do tipo)</span>
                          }
                        </div>
                        @for (subType of getSubTypesForInvestmentType(typeAlloc.investment_type_id); track subType.id; let subIndex = $index) {
                          <div class="sub-allocation-row">
                            <span>{{ subType.name }}</span>
                            <div class="percentage-input">
                              <input
                                type="number"
                                min="0"
                                max="100"
                                step="0.1"
                                [ngModel]="getSubTypeAllocation(typeIndex, subType.id)?.target_percentage || 0"
                                (ngModelChange)="onSubTypePercentageChange(typeIndex, subIndex, $event, subType.id)"
                              />
                              <span>%</span>
                            </div>
                          </div>
                        }
                      </div>
                    }
                  </article>
                }
              </div>
            </section>
          } @else {
            <div class="empty-card">
              <p>Nenhuma estratégia configurada. Clique em "Configurar Estratégia" para começar.</p>
              <button class="btn btn-primary" (click)="onConfigureStrategy()">Configurar Estratégia</button>
            </div>
          }

          @if (strategy) {
            <section class="details-card">
              <h4>Detalhes da Estratégia</h4>
              <div class="detail-row">
                <span class="detail-label">Valor total do portfólio</span>
                <div class="percentage-input">
                  <input
                    type="number"
                    step="0.01"
                    [(ngModel)]="totalPortfolioValueInput"
                    placeholder="0,00"
                  />
                </div>
              </div>
              <div class="detail-row">
                <span class="detail-label">Criado em</span>
                <span class="detail-value">{{ strategy.created_at | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">Última atualização</span>
                <span class="detail-value">{{ strategy.updated_at | date:'dd/MM/yyyy HH:mm' }}</span>
              </div>
            </section>
          } @else {
            <section class="details-card">
              <h4>Nova Estratégia</h4>
              <div class="detail-row">
                <span class="detail-label">Valor total do portfólio</span>
                <div class="percentage-input">
                  <input
                    type="number"
                    step="0.01"
                    [(ngModel)]="totalPortfolioValueInput"
                    placeholder="0,00"
                  />
                </div>
              </div>
            </section>
          }

          <div class="actions-bar">
            <button class="btn btn-primary" (click)="onSaveStrategy()" [disabled]="isSaving || !isTypeTotalValid">
              {{ isSaving ? 'Salvando...' : 'Salvar Estratégia' }}
            </button>
          </div>
        } @else {
          <div class="empty-card">
            <p>Este usuário ainda não possui estratégia definida.</p>
            <button class="btn btn-primary" (click)="onConfigureStrategy()">Criar Estratégia</button>
          </div>
        }
      }

        <!-- Rebalancing Tab -->
        @if (activeTab === 'rebalancing') {
          <div class="rebalancing-content">
            <!-- Generate Recommendations Button -->
            <div class="actions-bar">
              <button 
                class="btn btn-primary" 
                (click)="generateRecommendations()" 
                [disabled]="isGeneratingRecommendations || !strategy"
              >
                {{ isGeneratingRecommendations ? 'Gerando...' : 'Gerar Recomendações de Rebalanceamento' }}
              </button>
            </div>

            <!-- Summary Section -->
            @if (currentAllocation) {
              <section class="summary-card">
                <h4>Resumo do Portfólio</h4>
                <div class="summary-grid">
                  <div class="summary-item">
                    <span class="summary-label">Valor Total do Portfólio</span>
                    <span class="summary-value">R$ {{ currentAllocation.current?.total_value | number:'1.2-2' }}</span>
                  </div>
                  @if (getRendaFixaTotal()) {
                    <div class="summary-item">
                      <span class="summary-label">Valor Total Renda Fixa</span>
                      <div class="summary-value-row">
                        <span class="summary-value">R$ {{ getRendaFixaTotal()?.value | number:'1.2-2' }}</span>
                        <span class="summary-percentage">{{ getRendaFixaTotal()?.percentage | number:'1.2-2' }}%</span>
                      </div>
                    </div>
                  }
                  @if (getRendaVarDolaresTotal()) {
                    <div class="summary-item">
                      <span class="summary-label">Valor Total Renda Variável em Dólar</span>
                      <div class="summary-value-row">
                        <span class="summary-value">R$ {{ getRendaVarDolaresTotal()?.value | number:'1.2-2' }}</span>
                        <span class="summary-percentage">{{ getRendaVarDolaresTotal()?.percentage | number:'1.2-2' }}%</span>
                      </div>
                    </div>
                  }
                  @if (getRendaVarReaisTotal()) {
                    <div class="summary-item">
                      <span class="summary-label">Valor Total Renda Variável em Reais</span>
                      <div class="summary-value-row">
                        <span class="summary-value">R$ {{ getRendaVarReaisTotal()?.value | number:'1.2-2' }}</span>
                        <span class="summary-percentage">{{ getRendaVarReaisTotal()?.percentage | number:'1.2-2' }}%</span>
                      </div>
                    </div>
                  }
                  @if (currentRecommendation) {
                    <div class="summary-item">
                      <span class="summary-label">Limite de Vendas Restante</span>
                      <span class="summary-value" [class.warning]="currentRecommendation.sales_limit_remaining < 5000">
                        R$ {{ currentRecommendation.sales_limit_remaining | number:'1.2-2' }}
                      </span>
                      @if (currentRecommendation.sales_limit_reached) {
                        <span class="warning-badge">Limite atingido!</span>
                      }
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">Vendas Já Realizadas no Mês</span>
                      <span class="summary-value">R$ {{ currentRecommendation.previous_sales_this_month | number:'1.2-2' }}</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">Vendas Completas Recomendadas</span>
                      <span class="summary-value">R$ {{ currentRecommendation.total_complete_sales_value | number:'1.2-2' }}</span>
                    </div>
                    <div class="summary-item">
                      <span class="summary-label">Vendas Parciais Recomendadas</span>
                      <span class="summary-value">
                        R$ {{ currentRecommendation.total_partial_sales_value | number:'1.2-2' }}
                        <span class="info-badge">({{ currentRecommendation.partial_sales_count }} ações)</span>
                      </span>
                    </div>
                  }
                </div>
              </section>
            }

            <!-- Recommendations Display -->
            @if (isLoadingRecommendations) {
              <div class="status-card">
                <p>Carregando recomendações...</p>
              </div>
            } @else if (currentRecommendation) {
              <!-- Renda Fixa Section - Type-Level Summary and Subtype Groups -->
              @if (getRendaFixaActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Renda Fixa - Rebalanceamento</h4>
                  
                  <!-- Type-Level Summary -->
                  @if (getRendaFixaTypeActions().length > 0) {
                    <div class="type-action-group">
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Recomendação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getRendaFixaTypeActions(); track action.id) {
                            <tr>
                              <td><strong>Renda Fixa</strong></td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                      
                      <!-- SubType-Level Summary -->
                      <div class="subtype-level-summary">
                        @for (subtypeGroup of getRendaFixaActionsBySubtype(); track subtypeGroup.subtypeName) {
                          <div class="subtype-action-group">
                            <h5>{{ subtypeGroup.subtypeName }}</h5>
                            <table class="actions-table">
                              <thead>
                                <tr>
                                  <th>Sub-Tipo de Investimento</th>
                                  <th>Valor Atual</th>
                                  <th>Valor Alvo</th>
                                  <th>Diferença</th>
                                  <th>Recomendação</th>
                                </tr>
                              </thead>
                              <tbody>
                                @if (subtypeGroup.subtypeActions.length > 0) {
                                  @for (action of subtypeGroup.subtypeActions; track action.id) {
                                    <tr>
                                      <td>{{ action.subtype_display_name || action.investment_subtype?.name || action.subtype_name || 'Renda Fixa' }}</td>
                                      <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                      <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                      <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                        R$ {{ action.difference | number:'1.2-2' }}
                                      </td>
                                      <td>
                                        @if (action.quantity_to_buy) {
                                          <span class="badge badge-buy">Aumentar</span>
                                        } @else if (action.quantity_to_sell) {
                                          <span class="badge badge-sell">Reduzir</span>
                                        } @else if (action.difference > 0) {
                                          <span class="badge badge-buy">Aumentar</span>
                                        } @else if (action.difference < 0) {
                                          <span class="badge badge-sell">Reduzir</span>
                                        } @else {
                                          <span class="badge badge-maintain">Manter</span>
                                        }
                                      </td>
                                    </tr>
                                  }
                                } @else {
                                  <tr>
                                    <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                                      Nenhuma ação de rebalanceamento necessária para este subtipo
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        }
                      </div>
                    </div>
                  } @else {
                    <!-- Fallback: Show subtype groups if no type-level actions -->
                    @for (subtypeGroup of getRendaFixaActionsBySubtype(); track subtypeGroup.subtypeName) {
                      <div class="subtype-action-group">
                        <h5>{{ subtypeGroup.subtypeName }}</h5>
                        <table class="actions-table">
                          <thead>
                            <tr>
                              <th>Sub-Tipo de Investimento</th>
                              <th>Valor Atual</th>
                              <th>Valor Alvo</th>
                              <th>Diferença</th>
                              <th>Recomendação</th>
                            </tr>
                          </thead>
                          <tbody>
                            @if (subtypeGroup.subtypeActions.length > 0) {
                              @for (action of subtypeGroup.subtypeActions; track action.id) {
                                <tr>
                                  <td>{{ action.subtype_display_name || action.investment_subtype?.name || action.subtype_name || 'Renda Fixa' }}</td>
                                  <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                  <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                  <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                    R$ {{ action.difference | number:'1.2-2' }}
                                  </td>
                                  <td>
                                    @if (action.quantity_to_buy) {
                                      <span class="badge badge-buy">Aumentar</span>
                                    } @else if (action.quantity_to_sell) {
                                      <span class="badge badge-sell">Reduzir</span>
                                    } @else if (action.difference > 0) {
                                      <span class="badge badge-buy">Aumentar</span>
                                    } @else if (action.difference < 0) {
                                      <span class="badge badge-sell">Reduzir</span>
                                    } @else {
                                      <span class="badge badge-maintain">Manter</span>
                                    }
                                  </td>
                                </tr>
                              }
                            } @else {
                              <tr>
                                <td colspan="5" style="text-align: center; color: var(--text-secondary); padding: 1rem;">
                                  Nenhuma ação de rebalanceamento necessária para este subtipo
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    }
                  }
                </section>
              }

              <!-- Renda Variável em Dólares Section - Nested Structure as per Design -->
              @if (getAcoesDolaresActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Renda Variável em Dólares - Rebalanceamento</h4>
                  
                  <!-- Type-Level Summary -->
                  @if (getRendaVarDolaresTypeActions().length > 0) {
                    <div class="type-action-group">
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getRendaVarDolaresTypeActions(); track action.id) {
                            <tr>
                              <td><strong>Renda Variável em Dólares</strong></td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                      
                      <!-- SubType-Level Summary - Nested inside Type-Level -->
                      <div class="subtype-level-summary">
                        <!-- BDRs Subsection -->
                        @if (getBDRsSubtypeActions().length > 0) {
                          <div class="subtype-action-group">
                            <h5>BDRs</h5>
                            <table class="actions-table">
                              <thead>
                                <tr>
                                  <th>Ticker</th>
                                  <th>Nome</th>
                                  <th>Valor Atual</th>
                                  <th>Valor Alvo</th>
                                  <th>Diferença</th>
                                  <th>Ação</th>
                                </tr>
                              </thead>
                              <tbody>
                                @for (action of getBDRsSubtypeActions(); track action.id) {
                                  <tr>
                                    <td><strong>{{ action.stock?.ticker || '-' }}</strong></td>
                                    <td>{{ action.stock?.name || '-' }}</td>
                                    <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                    <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                    <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                      R$ {{ action.difference | number:'1.2-2' }}
                                    </td>
                                    <td>
                                      @if (action.quantity_to_buy) {
                                        <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                      } @else if (action.quantity_to_sell) {
                                        <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                      } @else if (action.difference > 0) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.difference < 0) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else {
                                        <span class="badge badge-maintain">Manter</span>
                                      }
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        }
                        
                        <!-- Crypto Subsection -->
                        @if (getCryptoSubtypeActions().length > 0) {
                          <div class="subtype-action-group">
                            <h5>Crypto</h5>
                            <table class="actions-table">
                              <thead>
                                <tr>
                                  <th>Ticker</th>
                                  <th>Nome</th>
                                  <th>Valor Atual</th>
                                  <th>Valor Alvo</th>
                                  <th>Diferença</th>
                                  <th>Ação</th>
                                </tr>
                              </thead>
                              <tbody>
                                @for (action of getCryptoSubtypeActions(); track action.id) {
                                  <tr>
                                    <td>
                                      @if (action.crypto_currency_symbol) {
                                        <strong>{{ action.crypto_currency_symbol }}</strong>
                                      } @else {
                                        <strong>{{ action.subtype_name || action.investment_subtype?.name || '-' }}</strong>
                                      }
                                    </td>
                                    <td>
                                      @if (action.crypto_currency_name) {
                                        {{ action.crypto_currency_name }}
                                      } @else {
                                        {{ action.subtype_display_name || action.investment_subtype?.name || action.subtype_name || '-' }}
                                      }
                                    </td>
                                    <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                    <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                    <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                      R$ {{ action.difference | number:'1.2-2' }}
                                    </td>
                                    <td>
                                      @if (action.quantity_to_buy) {
                                        <span class="badge badge-buy">
                                          Comprar {{ (action.quantity_to_buy / 1000000) | number:'1.6-6' }} {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}
                                        </span>
                                      } @else if (action.quantity_to_sell) {
                                        <span class="badge badge-sell">
                                          Vender {{ (Math.abs(action.quantity_to_sell) / 1000000) | number:'1.6-6' }} {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}
                                        </span>
                                      } @else if (action.difference > 0) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.difference < 0) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else {
                                        <span class="badge badge-maintain">Manter</span>
                                      }
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        }
                      </div>
                    </div>
                  }
                </section>
              }

              <!-- Ações em Reais Section -->
              @if (getAcoesReaisSellActions().length > 0 || getAcoesReaisBuyActions().length > 0 || getAcoesReaisRebalanceActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Ações em Reais - Rebalanceamento</h4>
                  @if (currentRecommendation.sales_limit_reached) {
                    <div class="warning-banner">
                      <strong>Atenção:</strong> O limite de vendas de R$ 19.000 foi atingido. Algumas ações não puderam ser vendidas.
                    </div>
                  }
                  
                  <!-- Stocks to Sell -->
                  @if (getAcoesReaisSellActions().length > 0) {
                    <div class="action-group">
                      <h5>Ações para Vender</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ranking</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Atual</th>
                            <th>Quantidade</th>
                            <th>Motivo</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getAcoesReaisSellActions(); track action.id) {
                            <tr>
                              <td>
                                @if (action.display_order && action.display_order < 9999) {
                                  {{ action.display_order }}
                                } @else {
                                  -
                                }
                              </td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>{{ action.quantity_to_sell }}</td>
                              <td>
                                <span class="badge">
                                  @if (action.reason) {
                                    {{ action.reason }}
                                  } @else {
                                    @if (action.display_order && action.display_order < 9999) {
                                      Rank {{ action.display_order }} > 30
                                    } @else {
                                      Não está no AMBB 2.0
                                    }
                                  }
                                </span>
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }

                  <!-- Stocks to Buy -->
                  @if (getAcoesReaisBuyActions().length > 0) {
                    <div class="action-group">
                      <h5>Ações para Comprar</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ranking</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Alvo</th>
                            <th>Quantidade</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getAcoesReaisBuyActions(); track action.id) {
                            <tr>
                              <td>{{ action.display_order }}</td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td>{{ action.quantity_to_buy }}</td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }

                  <!-- Stocks to Balance -->
                  @if (getAcoesReaisRebalanceActions().length > 0) {
                    <div class="action-group">
                      <h5>Ações para Rebalancear</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ranking</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getAcoesReaisRebalanceActions(); track action.id) {
                            <tr>
                              <td>{{ action.display_order }}</td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }
                </section>
              }

              <!-- Recommendation Actions -->
              <div class="actions-bar">
                <button 
                  class="btn btn-success" 
                  (click)="applyRecommendation(currentRecommendation.id)"
                >
                  Aplicar Recomendação
                </button>
                <button 
                  class="btn btn-secondary" 
                  (click)="dismissRecommendation(currentRecommendation.id)"
                >
                  Descartar
                </button>
              </div>
            } @else if (!isGeneratingRecommendations) {
              <div class="empty-card">
                <p>Nenhuma recomendação de rebalanceamento disponível.</p>
                <p class="hint">Clique em "Gerar Recomendações" para criar uma nova recomendação mensal.</p>
              </div>
            }
          </div>
        }
      </div>
    }
  </section>
</div>
