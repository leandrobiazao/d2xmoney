<div class="allocation-strategy-app">
  <!-- Sidebar (only shown when userId is not provided) -->
  @if (!userId) {
  <aside class="user-sidebar">
    <div class="sidebar-header">
      <h2>Estratégia de Alocação</h2>
      <p>Selecione um usuário para configurar sua estratégia</p>
    </div>

    @if (isLoading) {
      <div class="sidebar-fallback">
        <p>Carregando usuários...</p>
      </div>
    } @else if (users.length === 0) {
      <div class="sidebar-fallback">
        <p>Nenhum usuário cadastrado.</p>
      </div>
    } @else {
      <div class="user-grid">
        @for (user of users; track user.id) {
          <app-user-item
            [user]="user"
            [selected]="selectedUser?.id === user.id"
            (select)="onUserSelected($event)"
          />
        }
      </div>
    }
  </aside>
  }

  <!-- Content -->
  <section class="content-area">
    @if (isLoadingStrategy) {
      <div class="status-card">
        <p>Carregando estratégia de alocação...</p>
      </div>
    } @else if (!selectedUser) {
      <div class="fallback-message">
        <p>Selecione um usuário para visualizar a estratégia.</p>
      </div>
    } @else if (errorMessage) {
      <div class="error-card">
        <p>{{ errorMessage }}</p>
        <button class="btn btn-primary" (click)="loadStrategy(selectedUser.id)">Tentar novamente</button>
      </div>
    } @else {
      <div class="strategy-content">
        <!-- Tabs -->
        <div class="tabs-container">
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'configuration'"
            (click)="onTabChange('configuration')"
          >
            Configuração
          </button>
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'rebalancing'"
            (click)="onTabChange('rebalancing')"
          >
            Rebalanceamento
          </button>
        </div>

        <!-- Configuration Tab -->
        @if (activeTab === 'configuration') {
          @if (strategy || draftTypeAllocations.length > 0) {
            @if (draftTypeAllocations.length > 0) {
            <section class="allocations-panel">
              <h4>Alocações por tipo</h4>
              @if (!isTypeTotalValid) {
                <div class="validation-banner invalid">
                  <span>Total: {{ typeAllocationTotal | number:'1.0-2' }}%</span>
                  <span>As alocações por tipo precisam somar 100%</span>
                </div>
              }
              <div class="allocations-list">
                @for (typeAlloc of draftTypeAllocations; track typeAlloc.id || typeAlloc.investment_type.id; let typeIndex = $index) {
                  <article class="allocation-card">
                    <div class="allocation-table">
                      <div class="allocation-table-header">
                        <div class="allocation-name-col">
                        </div>
                        <div class="allocation-values-grid-header">
                          <div class="value-column-header">
                            <label class="value-label">Porcentagem</label>
                          </div>
                          <div class="value-column-header">
                            <label class="value-label">Valor Atual</label>
                          </div>
                          <div class="value-column-header">
                            <label class="value-label">Valor Alvo</label>
                          </div>
                        </div>
                      </div>
                      <div class="allocation-table-row">
                        <div class="allocation-name-col">
                          <span class="type-name">{{ typeAlloc.investment_type.name }}</span>
                        </div>
                        <div class="allocation-values-grid">
                          <div class="value-column">
                            <div class="percentage-input">
                              @if (isFIIInvestmentType(typeAlloc)) {
                                <!-- FII type: show FII total as readonly -->
                                <input
                                  type="number"
                                  min="0"
                                  max="100"
                                  step="0.1"
                                  [value]="getFIITotal(typeAlloc)"
                                  readonly
                                  disabled
                                  class="readonly-input"
                                />
                              } @else if (getSubTypesForInvestmentType(typeAlloc.investment_type_id).length > 0) {
                                <!-- Has subtypes: show subtype total as readonly -->
                                <input
                                  type="number"
                                  min="0"
                                  max="100"
                                  step="0.1"
                                  [value]="getSubTypeTotal(typeAlloc)"
                                  readonly
                                  disabled
                                  class="readonly-input"
                                />
                              } @else {
                                <!-- No subtypes or FIIs: editable input -->
                                <input
                                  type="number"
                                  min="0"
                                  max="100"
                                  step="0.1"
                                  [ngModel]="typeAlloc.target_percentage"
                                  (ngModelChange)="onTypePercentageChange(typeIndex, $event)"
                                />
                              }
                              <span>%</span>
                            </div>
                          </div>
                          <div class="value-column">
                            <span class="value-text current-value">R$ {{ getCurrentTypeValue(typeAlloc.investment_type_id) | number:'1.2-2' }}</span>
                          </div>
                          <div class="value-column">
                            <span class="value-text target-value">R$ {{ getTargetTypeValue(typeAlloc) | number:'1.2-2' }}</span>
                          </div>
                        </div>
                      </div>

                      @if (getSubTypesForInvestmentType(typeAlloc.investment_type_id).length > 0 && !isFIIInvestmentType(typeAlloc)) {
                        <div class="sub-allocations">
                          @if (!isSubTypeTotalValid(typeAlloc)) {
                            <div class="validation-banner small invalid">
                              <span>Total por subtipo: {{ getSubTypeTotal(typeAlloc) | number:'1.0-2' }}% / {{ typeAlloc.target_percentage | number:'1.0-2' }}%</span>
                              <span>Os subtipos precisam somar {{ typeAlloc.target_percentage | number:'1.0-2' }}% (mesmo valor do tipo)</span>
                            </div>
                          }
                          @for (subType of getSubTypesForInvestmentType(typeAlloc.investment_type_id); track subType.id; let subIndex = $index) {
                            <div class="allocation-table-row">
                              <div class="allocation-name-col">
                                <span class="subtype-name">{{ subType.name }}</span>
                              </div>
                              <div class="allocation-values-grid">
                                <div class="value-column">
                                  <div class="percentage-input">
                                    @if (isETFRendaFixaSubType(subType)) {
                                      <!-- ETF Renda Fixa: readonly percentage reflecting ETF row -->
                                      <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        step="0.1"
                                        [value]="getSubTypeAllocation(typeIndex, subType.id)?.target_percentage || 0"
                                        readonly
                                        disabled
                                        class="readonly-input"
                                      />
                                    } @else {
                                      <!-- Normal subtype: editable percentage -->
                                      <input
                                        type="number"
                                        min="0"
                                        max="100"
                                        step="0.1"
                                        [ngModel]="getSubTypeAllocation(typeIndex, subType.id)?.target_percentage || 0"
                                        (ngModelChange)="onSubTypePercentageChange(typeIndex, subIndex, $event, subType.id)"
                                      />
                                    }
                                    <span>%</span>
                                  </div>
                                </div>
                                <div class="value-column">
                                  <span class="value-text current-value">R$ {{ getCurrentSubTypeValue(typeAlloc.investment_type_id, subType.id) | number:'1.2-2' }}</span>
                                </div>
                                <div class="value-column">
                                  <span class="value-text target-value">R$ {{ getTargetSubTypeValue(typeAlloc, subType.id) | number:'1.2-2' }}</span>
                                </div>
                              </div>
                            </div>
                            <!-- ETF Renda Fixa: Sub-container with ETF dropdown and editable percentage -->
                            @if (isETFRendaFixaSubType(subType)) {
                              <div class="etf-allocations">
                                <div class="allocation-table-row etf-row">
                                  <div class="allocation-name-col">
                                    <select 
                                      class="etf-select"
                                      [ngModel]="getSelectedETFForSubType(typeIndex, subType.id)?.stock_id || ''"
                                      (ngModelChange)="onETFSelectChange(typeIndex, subType.id, $event)">
                                      <option value="">Selecione um ETF</option>
                                      @for (stock of etfRendaFixaStocks; track stock.id) {
                                        <option [ngValue]="stock.id">
                                          {{ stock.ticker }} - {{ stock.name }}
                                        </option>
                                      }
                                    </select>
                                  </div>
                                  <div class="allocation-values-grid">
                                    <div class="value-column">
                                      <!-- Editable percentage for ETF -->
                                      <div class="percentage-input">
                                        <input
                                          type="number"
                                          min="0"
                                          max="100"
                                          step="0.1"
                                          [ngModel]="getSubTypeAllocation(typeIndex, subType.id)?.target_percentage || 0"
                                          (ngModelChange)="onSubTypePercentageChange(typeIndex, subIndex, $event, subType.id)"
                                        />
                                        <span>%</span>
                                      </div>
                                    </div>
                                    <div class="value-column">
                                      <span class="value-text current-value">R$ {{ getETFCurrentValue(typeIndex, subType.id) | number:'1.2-2' }}</span>
                                    </div>
                                    <div class="value-column">
                                      <span class="value-text target-value">R$ {{ getTargetSubTypeValue(typeAlloc, subType.id) | number:'1.2-2' }}</span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            }
                          }
                        </div>
                      }

                      <!-- FII Allocations - Show when investment type is FIIs -->
                      @if (isFIIInvestmentType(typeAlloc)) {
                        <div class="fii-allocations">
                          <!-- Validation banner -->
                          @if (!isFIITotalValid(typeAlloc)) {
                            <div class="validation-banner small invalid">
                              <span>Total FIIs: {{ getFIITotal(typeAlloc) | number:'1.0-2' }}% / {{ typeAlloc.target_percentage | number:'1.0-2' }}%</span>
                              <span>Os FIIs precisam somar {{ typeAlloc.target_percentage | number:'1.0-2' }}% (mesmo valor do tipo)</span>
                            </div>
                          }
                          
                          <!-- 5 FII rows (0-4) -->
                          @for (rowIndex of [0, 1, 2, 3, 4]; track rowIndex) {
                            <div class="allocation-table-row fii-row">
                              <div class="allocation-name-col">
                                <select 
                                  class="fii-select"
                                  [ngModel]="getFIIAtRow(typeIndex, rowIndex)?.stock_id || ''"
                                  (ngModelChange)="onFIISelectChange(typeIndex, rowIndex, $event)">
                                  <option value="">Selecione um FII</option>
                                  @for (fii of getAvailableFIIsForRow(typeIndex, rowIndex); track fii.stock_id) {
                                    <option [ngValue]="fii.stock_id">
                                      {{ fii.ticker }} - {{ fii.segment || 'FII' }}
                                    </option>
                                  }
                                </select>
                              </div>
                              <div class="allocation-values-grid">
                                <!-- Percentage input -->
                                <div class="value-column">
                                  <div class="percentage-input">
                                    <input
                                      type="number"
                                      min="0"
                                      max="100"
                                      step="0.1"
                                      [ngModel]="getFIIAtRow(typeIndex, rowIndex)?.target_percentage || 0"
                                      (ngModelChange)="onFIIPercentageChange(typeIndex, rowIndex, $event)"
                                      [disabled]="!getFIIAtRow(typeIndex, rowIndex)"
                                    />
                                    <span>%</span>
                                  </div>
                                </div>
                                <!-- Current value -->
                                <div class="value-column">
                                  <span class="value-text current-value">
                                    @if (getFIIAtRow(typeIndex, rowIndex); as fii) {
                                      R$ {{ getCurrentFIIValue(typeAlloc.investment_type_id, getFIITicker(fii)) | number:'1.2-2' }}
                                    } @else {
                                      R$ 0,00
                                    }
                                  </span>
                                </div>
                                <!-- Target value -->
                                <div class="value-column">
                                  <span class="value-text target-value">
                                    @if (getFIIAtRow(typeIndex, rowIndex); as fii) {
                                      R$ {{ getTargetFIIValue(typeAlloc, fii) | number:'1.2-2' }}
                                    } @else {
                                      R$ 0,00
                                    }
                                  </span>
                                </div>
                              </div>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </article>
                }
              </div>
            </section>
            } @else {
              <div class="empty-card">
                <p>Nenhuma estratégia configurada. Clique em "Configurar Estratégia" para começar.</p>
                <button class="btn btn-primary" (click)="onConfigureStrategy()">Configurar Estratégia</button>
              </div>
            }

            @if (strategy) {
              <div class="actions-bar">
                <button class="btn btn-primary" (click)="onSaveStrategy()" [disabled]="isSaving || !isTypeTotalValid">
                  {{ isSaving ? 'Salvando...' : 'Salvar Estratégia' }}
                </button>
              </div>
            }
          } @else {
            <div class="empty-card">
              <p>Este usuário ainda não possui estratégia definida.</p>
              <button class="btn btn-primary" (click)="onConfigureStrategy()">Criar Estratégia</button>
            </div>
          }
        }

        <!-- Rebalancing Tab -->
        @if (activeTab === 'rebalancing') {
          <div class="rebalancing-content">
            <!-- Summary Section -->
            @if (currentAllocation) {
              <section class="summary-card">
                <div class="summary-header">
                  <h4>Resumo do Portfólio</h4>
                </div>
                <div class="summary-total summary-item">
                  <div class="summary-total-content">
                    <span class="summary-label">Valor Total</span>
                    <span class="summary-value summary-total-value">R$ {{ currentAllocation.current?.total_value | number:'1.2-2' }}</span>
                  </div>
                  <button 
                    type="button"
                    class="btn-primary" 
                    (click)="generateRecommendations()" 
                    [disabled]="isGeneratingRecommendations || !strategy"
                  >
                    {{ isGeneratingRecommendations ? 'Gerando...' : 'Gerar Recomendações de Rebalanceamento' }}
                  </button>
                </div>
                <div class="summary-grid">
                  <div class="summary-item">
                    <span class="summary-label">Valor Total Renda Fixa</span>
                    <div class="summary-item-content">
                      <span class="summary-value">R$ {{ (getRendaFixaTotal()?.value || 0) | number:'1.2-2' }}</span>
                      <span class="summary-percentage">{{ (getRendaFixaTotal()?.percentage || 0) | number:'1.2-2' }}%</span>
                    </div>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Valor Total Renda Variável em Dólar</span>
                    <div class="summary-item-content">
                      <span class="summary-value">R$ {{ (getRendaVarDolaresTotal()?.value || 0) | number:'1.2-2' }}</span>
                      <span class="summary-percentage">{{ (getRendaVarDolaresTotal()?.percentage || 0) | number:'1.2-2' }}%</span>
                    </div>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Valor Total Renda Variável em Reais</span>
                    <div class="summary-item-content">
                      <span class="summary-value">R$ {{ (getRendaVarReaisTotal()?.value || 0) | number:'1.2-2' }}</span>
                      <span class="summary-percentage">{{ (getRendaVarReaisTotal()?.percentage || 0) | number:'1.2-2' }}%</span>
                    </div>
                  </div>
                </div>
              </section>
            }

            <!-- Recommendations Display -->
            @if (isLoadingRecommendations) {
              <div class="status-card">
                <p>Carregando recomendações...</p>
              </div>
            } @else if (currentRecommendation) {
              <!-- Renda Fixa Section - Type-Level Summary and Subtype Groups -->
              @if (getRendaFixaActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Renda Fixa - Rebalanceamento</h4>
                  
                  <!-- Type-Level Summary -->
                  @if (getRendaFixaTypeActions().length > 0) {
                    <div class="type-action-group">
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Recomendação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getRendaFixaTypeActions(); track action.id) {
                            <tr>
                              <td><strong>Renda Fixa</strong></td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                      
                      <!-- SubType-Level Summary -->
                      <div class="subtype-level-summary">
                        <table class="actions-table">
                          <thead>
                            <tr>
                              <th>Sub-Tipo de Investimento</th>
                              <th>Valor Atual</th>
                              <th>Valor Alvo</th>
                              <th>Diferença</th>
                              <th>Recomendação</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (subtypeGroup of getRendaFixaActionsBySubtype(); track subtypeGroup.subtypeName) {
                              @if (subtypeGroup.subtypeActions.length > 0) {
                                @for (action of subtypeGroup.subtypeActions; track action.id) {
                                  <tr>
                                    <td>{{ action.subtype_display_name || action.investment_subtype?.name || action.subtype_name || 'Renda Fixa' }}</td>
                                    <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                    <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                    <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                      R$ {{ action.difference | number:'1.2-2' }}
                                    </td>
                                    <td>
                                      @if (action.quantity_to_buy) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.quantity_to_sell) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else if (action.difference > 0) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.difference < 0) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else {
                                        <span class="badge badge-maintain">Manter</span>
                                      }
                                    </td>
                                  </tr>
                                }
                              }
                            }
                          </tbody>
                        </table>
                      </div>
                    </div>
                  } @else {
                    <!-- Fallback: Show subtype groups if no type-level actions -->
                    <table class="actions-table">
                      <thead>
                        <tr>
                          <th>Sub-Tipo de Investimento</th>
                          <th>Valor Atual</th>
                          <th>Valor Alvo</th>
                          <th>Diferença</th>
                          <th>Recomendação</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (subtypeGroup of getRendaFixaActionsBySubtype(); track subtypeGroup.subtypeName) {
                          @if (subtypeGroup.subtypeActions.length > 0) {
                            @for (action of subtypeGroup.subtypeActions; track action.id) {
                              <tr>
                                <td>{{ action.subtype_display_name || action.investment_subtype?.name || action.subtype_name || 'Renda Fixa' }}</td>
                                <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                  R$ {{ action.difference | number:'1.2-2' }}
                                </td>
                                <td>
                                  @if (action.quantity_to_buy) {
                                    <span class="badge badge-buy">Aumentar</span>
                                  } @else if (action.quantity_to_sell) {
                                    <span class="badge badge-sell">Reduzir</span>
                                  } @else if (action.difference > 0) {
                                    <span class="badge badge-buy">Aumentar</span>
                                  } @else if (action.difference < 0) {
                                    <span class="badge badge-sell">Reduzir</span>
                                  } @else {
                                    <span class="badge badge-maintain">Manter</span>
                                  }
                                </td>
                              </tr>
                            }
                          }
                        }
                      </tbody>
                    </table>
                  }
                  
                  <!-- ETF Renda Fixa Subsection -->
                  @if (getETFRendaFixaActions().length > 0) {
                    <div class="subtype-action-group etf-renda-fixa-group">
                      <h5>ETF Renda Fixa</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getETFRendaFixaActions(); track action.id) {
                            <tr>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy && action.quantity_to_buy > 0) {
                                  <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                } @else if (action.quantity_to_sell && action.quantity_to_sell > 0) {
                                  <span class="badge badge-sell">Vender {{ action.quantity_to_sell }}</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }
                </section>
              }

              <!-- Renda Variável em Dólares Section - Nested Structure as per Design -->
              @if (getAcoesDolaresActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Renda Variável em Dólares - Rebalanceamento</h4>
                  
                  <!-- Type-Level Summary -->
                  @if (getRendaVarDolaresTypeActions().length > 0) {
                    <div class="type-action-group">
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getRendaVarDolaresTypeActions(); track action.id) {
                            <tr>
                              <td><strong>Renda Variável em Dólares</strong></td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                      
                      <!-- SubType-Level Summary - Nested inside Type-Level -->
                      <div class="subtype-level-summary">
                        <!-- BDRs Subsection -->
                        @if (getBDRsSubtypeActions().length > 0) {
                          <div class="subtype-action-group">
                            <h5>BDRs</h5>
                            <table class="actions-table">
                              <thead>
                                <tr>
                                  <th>Ticker</th>
                                  <th>Nome</th>
                                  <th>Valor Atual</th>
                                  <th>Valor Alvo</th>
                                  <th>Diferença</th>
                                  <th>Ação</th>
                                </tr>
                              </thead>
                              <tbody>
                                @for (action of getBDRsSubtypeActions(); track action.id) {
                                  <tr>
                                    <td><strong>{{ action.stock?.ticker || '-' }}</strong></td>
                                    <td>{{ action.stock?.name || '-' }}</td>
                                    <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                    <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                    <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                      R$ {{ action.difference | number:'1.2-2' }}
                                    </td>
                                    <td>
                                      @if (action.quantity_to_buy) {
                                        <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                      } @else if (action.quantity_to_sell) {
                                        <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                      } @else if (action.difference > 0) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.difference < 0) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else {
                                        <span class="badge badge-maintain">Manter</span>
                                      }
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        }
                        
                        <!-- Crypto Subsection -->
                        @for (subtypeGroup of getCryptoSubtypeActionsGrouped(); track subtypeGroup.subtypeName) {
                          @if (subtypeGroup.subtypeActions.length > 0) {
                            <div class="subtype-action-group">
                              <h5>{{ subtypeGroup.subtypeName }}</h5>
                              <table class="actions-table">
                                <thead>
                                  <tr>
                                    <th>Ticker</th>
                                    <th>Nome</th>
                                    <th>Valor Atual</th>
                                    <th>Valor Alvo</th>
                                    <th>Diferença</th>
                                    <th>Ação</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  @for (action of subtypeGroup.subtypeActions; track action.id) {
                                    <!-- Only show individual crypto actions (with crypto symbol like "BTC") -->
                                    @if (isCryptoSymbol(action.subtype_name)) {
                                      <tr>
                                        <td><strong>{{ action.subtype_name || action.crypto_currency_symbol || '-' }}</strong></td>
                                        <td>{{ getCryptoDisplayName(action.crypto_currency_name) }}</td>
                                        <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                        <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                        <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                          R$ {{ action.difference | number:'1.2-2' }}
                                        </td>
                                        <td>
                                          @if (action.quantity_to_buy && action.quantity_to_buy > 0) {
                                            <span class="badge badge-buy">
                                              Comprar {{ (action.quantity_to_buy / 1000000) | number:'1.6-6' }} {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}
                                            </span>
                                          } @else if (action.quantity_to_sell && action.quantity_to_sell > 0) {
                                            <span class="badge badge-sell">
                                              Vender {{ (action.quantity_to_sell / 1000000) | number:'1.6-6' }} {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}
                                            </span>
                                          } @else if (action.difference > 0) {
                                            <span class="badge badge-buy">Comprar {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}</span>
                                          } @else if (action.difference < 0) {
                                            <span class="badge badge-sell">Vender {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}</span>
                                          } @else {
                                            <span class="badge badge-maintain">Manter</span>
                                          }
                                        </td>
                                      </tr>
                                    }
                                  }
                                </tbody>
                              </table>
                            </div>
                          }
                        }
                      </div>
                    </div>
                  }
                </section>
              }

              <!-- Ações em Reais Section -->
              @if (getAcoesReaisSellActions().length > 0 || getAcoesReaisBuyActions().length > 0 || getAcoesReaisRebalanceActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Renda Variável em Reais - Rebalanceamento</h4>
                  
                  <!-- Type-Level Summary Table -->
                  <div class="type-action-group">
                    <table class="actions-table">
                      <thead>
                        <tr>
                          <th>Tipo</th>
                          <th>Valor Atual</th>
                          <th>Valor Alvo</th>
                          <th>Diferença</th>
                          <th>Ação</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr>
                          <td><strong>Renda Variável em Reais</strong></td>
                          <td>R$ {{ (getRendaVarReaisTotal()?.value || 0) | number:'1.2-2' }}</td>
                          <td>R$ {{ getTargetTypeValueByCode('RENDA_VARIAVEL_REAIS') | number:'1.2-2' }}</td>
                          <td [class.positive]="(getTargetTypeValueByCode('RENDA_VARIAVEL_REAIS') - (getRendaVarReaisTotal()?.value || 0)) > 0" 
                              [class.negative]="(getTargetTypeValueByCode('RENDA_VARIAVEL_REAIS') - (getRendaVarReaisTotal()?.value || 0)) < 0">
                            R$ {{ (getTargetTypeValueByCode('RENDA_VARIAVEL_REAIS') - (getRendaVarReaisTotal()?.value || 0)) | number:'1.2-2' }}
                          </td>
                          <td>
                            @if ((getTargetTypeValueByCode('RENDA_VARIAVEL_REAIS') - (getRendaVarReaisTotal()?.value || 0)) > 100) {
                              <span class="badge badge-buy">Aumentar</span>
                            } @else if ((getTargetTypeValueByCode('RENDA_VARIAVEL_REAIS') - (getRendaVarReaisTotal()?.value || 0)) < -100) {
                              <span class="badge badge-sell">Reduzir</span>
                            } @else {
                              <span class="badge badge-maintain">Manter</span>
                            }
                          </td>
                        </tr>
                      </tbody>
                    </table>
                    
                    <!-- Sales Limit Summary Cards -->
                    <div class="sales-limit-cards">
                      <div class="sales-limit-card">
                        <span class="sales-limit-card-label">Vendas Já Realizadas no Mês</span>
                        <span class="sales-limit-card-value">R$ {{ currentRecommendation.previous_sales_this_month | number:'1.2-2' }}</span>
                      </div>
                      <div class="sales-limit-card">
                        <span class="sales-limit-card-label">Limite Disponível para Vendas</span>
                        <span class="sales-limit-card-value" [class.warning]="(19000 - currentRecommendation.previous_sales_this_month) < 5000">
                          R$ {{ (19000 - currentRecommendation.previous_sales_this_month) | number:'1.2-2' }}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  @if (currentRecommendation.sales_limit_reached) {
                    <div class="warning-banner">
                      <strong>Atenção:</strong> O limite de vendas de R$ 19.000 foi atingido. Algumas ações não puderam ser vendidas.
                    </div>
                  }
                  
                  <!-- SubType-Level Summary -->
                  <div class="subtype-level-summary">
                    <!-- Stocks to Sell (Complete Sales) -->
                    @if (getAcoesReaisSellActions().length > 0) {
                      <div class="action-group">
                        <h5>Ações em Reais - Vender</h5>
                        <table class="actions-table">
                          <thead>
                            <tr>
                              <th>Rank</th>
                              <th>Ticker</th>
                              <th>Nome</th>
                              <th>Valor Atual</th>
                              <th>Quant.</th>
                              <th>Motivo</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (action of getAcoesReaisSellActions(); track action.id) {
                              <tr>
                                <td>
                                  @if (action.display_order && action.display_order < 9999) {
                                    {{ action.display_order }}
                                  } @else {
                                    -
                                  }
                                </td>
                                <td><strong>{{ action.stock?.ticker }}</strong></td>
                                <td>{{ action.stock?.name }}</td>
                                <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                <td>{{ action.quantity_to_sell }}</td>
                                <td>
                                  <span class="badge badge-sell">
                                    @if (action.reason) {
                                      {{ action.reason }}
                                    } @else {
                                      @if (action.display_order && action.display_order < 9999) {
                                        Rank {{ action.display_order }} > 30
                                      } @else {
                                        Não está no AMBB 2.0
                                      }
                                    }
                                  </span>
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                        
                        <!-- Sales Summary Cards after Vender table -->
                        <div class="sales-limit-cards">
                          <div class="sales-limit-card">
                            <span class="sales-limit-card-label">Total Vendas - Liquidadas</span>
                            <span class="sales-limit-card-value">R$ {{ currentRecommendation.total_complete_sales_value | number:'1.2-2' }}</span>
                          </div>
                          <div class="sales-limit-card">
                            <span class="sales-limit-card-label">Limite para Vendas Parciais</span>
                            <span class="sales-limit-card-value" [class.warning]="(19000 - currentRecommendation.previous_sales_this_month - currentRecommendation.total_complete_sales_value) < 2000">
                              R$ {{ (19000 - currentRecommendation.previous_sales_this_month - currentRecommendation.total_complete_sales_value) | number:'1.2-2' }}
                            </span>
                          </div>
                        </div>
                      </div>
                    }

                    <!-- Stocks to Buy -->
                    @if (getAcoesReaisBuyActions().length > 0) {
                      <div class="action-group">
                        <h5>Ações em Reais - Comprar</h5>
                        <table class="actions-table">
                          <thead>
                            <tr>
                              <th>Rank</th>
                              <th>Ticker</th>
                              <th>Nome</th>
                              <th>Valor Alvo</th>
                              <th>Quant.</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (action of getAcoesReaisBuyActions(); track action.id) {
                              <tr>
                                <td>{{ action.display_order }}</td>
                                <td><strong>{{ action.stock?.ticker }}</strong></td>
                                <td>{{ action.stock?.name }}</td>
                                <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                <td>{{ action.quantity_to_buy }}</td>
                              </tr>
                            }
                          </tbody>
                        </table>
                      </div>
                    }

                    <!-- Stocks to Rebalance -->
                    @if (getAcoesReaisRebalanceActions().length > 0) {
                      <div class="action-group">
                        <h5>Ações em Reais - Rebalancear</h5>
                        <table class="actions-table">
                          <thead>
                            <tr>
                              <th>Rank</th>
                              <th>Ticker</th>
                              <th>Nome</th>
                              <th>Valor Atual</th>
                              <th>Valor Alvo</th>
                              <th>Dif.</th>
                              <th>Ação</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (action of getAcoesReaisRebalanceActions(); track action.id) {
                              <tr>
                                <td>{{ action.display_order }}</td>
                                <td><strong>{{ action.stock?.ticker }}</strong></td>
                                <td>{{ action.stock?.name }}</td>
                                <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                  R$ {{ action.difference | number:'1.2-2' }}
                                </td>
                                <td>
                                  @if (action.quantity_to_buy) {
                                    <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                  } @else if (action.quantity_to_sell) {
                                    <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                  } @else if (action.difference > 0) {
                                    <span class="badge badge-buy">Aumentar</span>
                                  } @else if (action.difference < 0) {
                                    <span class="badge badge-sell">Reduzir</span>
                                  } @else {
                                    <span class="badge badge-maintain">Manter</span>
                                  }
                                </td>
                              </tr>
                            }
                          </tbody>
                        </table>
                        
                        <!-- Partial Sales Summary Cards after Rebalancear table -->
                        <div class="sales-limit-cards">
                          <div class="sales-limit-card">
                            <span class="sales-limit-card-label">Vendas Parciais</span>
                            <span class="sales-limit-card-value">R$ {{ currentRecommendation.total_partial_sales_value | number:'1.2-2' }}</span>
                          </div>
                          <div class="sales-limit-card">
                            <span class="sales-limit-card-label">Limite de Vendas Restante</span>
                            <span class="sales-limit-card-value" [class.warning]="currentRecommendation.sales_limit_remaining < 2000">
                              R$ {{ currentRecommendation.sales_limit_remaining | number:'1.2-2' }}
                            </span>
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                </section>
              }

              <!-- Recommendation Actions -->
              <div class="actions-bar">
                <button 
                  class="btn btn-primary" 
                  (click)="exportRecommendationExcel()"
                >
                  Exportar Excel
                </button>
                <button 
                  class="btn btn-success" 
                  (click)="applyRecommendation(currentRecommendation.id)"
                >
                  Aplicar Recomendação
                </button>
                <button 
                  class="btn btn-secondary" 
                  (click)="dismissRecommendation(currentRecommendation.id)"
                >
                  Descartar
                </button>
              </div>
            } @else if (!isGeneratingRecommendations) {
              <div class="empty-card">
                <p>Nenhuma recomendação de rebalanceamento disponível.</p>
                <p class="hint">Clique em "Gerar Recomendações" para criar uma nova recomendação mensal.</p>
              </div>
            }
          </div>
        }
      </div>
    }
  </section>
</div>
