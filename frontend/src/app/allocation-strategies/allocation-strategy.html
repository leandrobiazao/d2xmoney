<div class="allocation-strategy-app">
  <!-- Sidebar (only shown when userId is not provided) -->
  @if (!userId) {
  <aside class="user-sidebar">
    <div class="sidebar-header">
      <h2>Estratégia de Alocação</h2>
      <p>Selecione um usuário para configurar sua estratégia</p>
    </div>

    @if (isLoading) {
      <div class="sidebar-fallback">
        <p>Carregando usuários...</p>
      </div>
    } @else if (users.length === 0) {
      <div class="sidebar-fallback">
        <p>Nenhum usuário cadastrado.</p>
      </div>
    } @else {
      <div class="user-grid">
        @for (user of users; track user.id) {
          <app-user-item
            [user]="user"
            [selected]="selectedUser?.id === user.id"
            (select)="onUserSelected($event)"
          />
        }
      </div>
    }
  </aside>
  }

  <!-- Content -->
  <section class="content-area">
    @if (isLoadingStrategy) {
      <div class="status-card">
        <p>Carregando estratégia de alocação...</p>
      </div>
    } @else if (!selectedUser) {
      <div class="fallback-message">
        <p>Selecione um usuário para visualizar a estratégia.</p>
      </div>
    } @else if (errorMessage) {
      <div class="error-card">
        <p>{{ errorMessage }}</p>
        <button class="btn btn-primary" (click)="loadStrategy(selectedUser.id)">Tentar novamente</button>
      </div>
    } @else {
      <div class="strategy-content">
        <!-- Tabs -->
        <div class="tabs-container">
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'configuration'"
            (click)="onTabChange('configuration')"
          >
            Configuração
          </button>
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'rebalancing'"
            (click)="onTabChange('rebalancing')"
          >
            Rebalanceamento
          </button>
        </div>

        <!-- Configuration Tab -->
        @if (activeTab === 'configuration') {
          @if (strategy || draftTypeAllocations.length > 0) {
            @if (draftTypeAllocations.length > 0) {
            <section class="allocations-panel">
              <h4>Alocações por tipo</h4>
              @if (!isTypeTotalValid) {
                <div class="validation-banner invalid">
                  <span>Total: {{ typeAllocationTotal | number:'1.0-2' }}%</span>
                  <span>As alocações por tipo precisam somar 100%</span>
                </div>
              }
              <div class="allocations-list">
                @for (typeAlloc of draftTypeAllocations; track typeAlloc.id || typeAlloc.investment_type.id; let typeIndex = $index) {
                  <article class="allocation-card">
                    <div class="allocation-table">
                      <div class="allocation-table-header">
                        <div class="allocation-name-col">
                        </div>
                        <div class="allocation-values-grid-header">
                          <div class="value-column-header">
                            <label class="value-label">Porcentagem</label>
                          </div>
                          <div class="value-column-header">
                            <label class="value-label">Valor Atual</label>
                          </div>
                          <div class="value-column-header">
                            <label class="value-label">Valor Alvo</label>
                          </div>
                        </div>
                      </div>
                      <div class="allocation-table-row">
                        <div class="allocation-name-col">
                          <span class="type-name">{{ typeAlloc.investment_type.name }}</span>
                        </div>
                        <div class="allocation-values-grid">
                          <div class="value-column">
                            <div class="percentage-input">
                              @if (isFIIInvestmentType(typeAlloc)) {
                                <input
                                  type="number"
                                  min="0"
                                  max="100"
                                  step="0.1"
                                  [ngModel]="typeAlloc.target_percentage"
                                  (ngModelChange)="onFIITypePercentageChange(typeIndex, $event)"
                                />
                              } @else if (getSubTypesForInvestmentType(typeAlloc.investment_type_id).length > 0) {
                                <input
                                  type="number"
                                  min="0"
                                  max="100"
                                  step="0.1"
                                  [value]="getSubTypeTotal(typeAlloc)"
                                  readonly
                                  disabled
                                  class="readonly-input"
                                />
                              } @else {
                                <input
                                  type="number"
                                  min="0"
                                  max="100"
                                  step="0.1"
                                  [ngModel]="typeAlloc.target_percentage"
                                  (ngModelChange)="onTypePercentageChange(typeIndex, $event)"
                                />
                              }
                              <span>%</span>
                            </div>
                          </div>
                          <div class="value-column">
                            <span class="value-text current-value">R$ {{ getCurrentTypeValue(typeAlloc.investment_type_id) | number:'1.2-2' }}</span>
                          </div>
                          <div class="value-column">
                            <span class="value-text target-value">R$ {{ getTargetTypeValue(typeAlloc) | number:'1.2-2' }}</span>
                          </div>
                        </div>
                      </div>

                      @if (isFIIInvestmentType(typeAlloc)) {
                        <!-- FII Selection Panel -->
                        <div class="fii-selection-panel">
                          @if (!isFIITotalValid(typeAlloc)) {
                            <div class="validation-banner small invalid">
                              <span>Total por FII: {{ getFIITotal(typeAlloc) | number:'1.0-2' }}% / {{ typeAlloc.target_percentage | number:'1.0-2' }}%</span>
                              <span>Os FIIs precisam somar {{ typeAlloc.target_percentage | number:'1.0-2' }}% (mesmo valor do tipo)</span>
                            </div>
                          }
                          
                          <!-- 5 Fixed FII Rows with Dropdowns -->
                          <table class="fii-rows-table">
                            <thead>
                              <tr>
                                <th>FII</th>
                                <th>Nome</th>
                                <th>Administrador</th>
                                <th>Porcentagem</th>
                                <th>Valor Atual</th>
                                <th>Valor Alvo</th>
                                <th>Ações</th>
                              </tr>
                            </thead>
                            <tbody>
                              @for (rowIndex of [0, 1, 2, 3, 4]; track rowIndex) {
                                @let fii = getFIIAtRow(typeIndex, rowIndex);
                                <tr class="fii-row" [class.fii-row-empty]="!fii">
                                  <td>
                                    <div class="fii-dropdown-container">
                                      <select
                                        class="fii-dropdown-select"
                                        [class.fii-dropdown-empty]="!fii"
                                        [ngModel]="fii ? (fii.stock_id || (fii.stock && fii.stock.id)) : ''"
                                        (ngModelChange)="onFIISelectChange(typeIndex, rowIndex, $event)"
                                      >
                                        <option value="">-- Selecione um FII --</option>
                                        @for (availableFii of getAvailableFIIsForRow(typeIndex, rowIndex); track availableFii.stock_id) {
                                          <option [value]="availableFii.stock_id">
                                            {{ availableFii.ticker }} - {{ availableFii.segment || 'N/A' }} | {{ availableFii.administrator || 'N/A' }}
                                          </option>
                                        }
                                      </select>
                                    </div>
                                  </td>
                                  <td>
                                    @if (fii) {
                                      {{ getFIIName(fii) }}
                                    } @else {
                                      <span class="fii-empty-text">--</span>
                                    }
                                  </td>
                                  <td>
                                    @if (fii) {
                                      {{ getFIIAdministrator(fii) }}
                                    } @else {
                                      <span class="fii-empty-text">--</span>
                                    }
                                  </td>
                                  <td>
                                    @if (fii) {
                                      <div class="percentage-input">
                                        <input
                                          type="number"
                                          min="0"
                                          max="100"
                                          step="0.1"
                                          [ngModel]="fii.target_percentage"
                                          (ngModelChange)="onFIIPercentageChange(typeIndex, rowIndex, $event)"
                                        />
                                        <span>%</span>
                                      </div>
                                    } @else {
                                      <span class="fii-empty-text">--</span>
                                    }
                                  </td>
                                  <td>
                                    @if (fii) {
                                      <span class="value-text current-value">R$ {{ getCurrentFIIValue(typeAlloc.investment_type_id, getFIITicker(fii)) | number:'1.2-2' }}</span>
                                    } @else {
                                      <span class="fii-empty-text">--</span>
                                    }
                                  </td>
                                  <td>
                                    @if (fii) {
                                      <span class="value-text target-value">R$ {{ getTargetFIIValue(typeAlloc, fii) | number:'1.2-2' }}</span>
                                    } @else {
                                      <span class="fii-empty-text">--</span>
                                    }
                                  </td>
                                  <td>
                                    @if (fii) {
                                      <button class="fii-remove-btn" (click)="onRemoveFIIAtRow(typeIndex, rowIndex)" type="button">×</button>
                                    } @else {
                                      <span class="fii-empty-text">--</span>
                                    }
                                  </td>
                                </tr>
                              }
                            </tbody>
                          </table>
                        </div>
                      } @else if (getSubTypesForInvestmentType(typeAlloc.investment_type_id).length > 0) {
                        <div class="sub-allocations">
                          @if (!isSubTypeTotalValid(typeAlloc)) {
                            <div class="validation-banner small invalid">
                              <span>Total por subtipo: {{ getSubTypeTotal(typeAlloc) | number:'1.0-2' }}% / {{ typeAlloc.target_percentage | number:'1.0-2' }}%</span>
                              <span>Os subtipos precisam somar {{ typeAlloc.target_percentage | number:'1.0-2' }}% (mesmo valor do tipo)</span>
                            </div>
                          }
                          @for (subType of getSubTypesForInvestmentType(typeAlloc.investment_type_id); track subType.id; let subIndex = $index) {
                            <div class="allocation-table-row">
                              <div class="allocation-name-col">
                                <span class="subtype-name">{{ subType.name }}</span>
                              </div>
                              <div class="allocation-values-grid">
                                <div class="value-column">
                                  <div class="percentage-input">
                                    <input
                                      type="number"
                                      min="0"
                                      max="100"
                                      step="0.1"
                                      [ngModel]="getSubTypeAllocation(typeIndex, subType.id)?.target_percentage || 0"
                                      (ngModelChange)="onSubTypePercentageChange(typeIndex, subIndex, $event, subType.id)"
                                    />
                                    <span>%</span>
                                  </div>
                                </div>
                                <div class="value-column">
                                  <span class="value-text current-value">R$ {{ getCurrentSubTypeValue(typeAlloc.investment_type_id, subType.id) | number:'1.2-2' }}</span>
                                </div>
                                <div class="value-column">
                                  <span class="value-text target-value">R$ {{ getTargetSubTypeValue(typeAlloc, subType.id) | number:'1.2-2' }}</span>
                                </div>
                              </div>
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </article>
                }
              </div>
            </section>
            } @else {
              <div class="empty-card">
                <p>Nenhuma estratégia configurada. Clique em "Configurar Estratégia" para começar.</p>
                <button class="btn btn-primary" (click)="onConfigureStrategy()">Configurar Estratégia</button>
              </div>
            }

            @if (strategy) {
              <div class="actions-bar">
                <button class="btn btn-primary" (click)="onSaveStrategy()" [disabled]="isSaving || !isTypeTotalValid">
                  {{ isSaving ? 'Salvando...' : 'Salvar Estratégia' }}
                </button>
              </div>
            }
          } @else {
            <div class="empty-card">
              <p>Este usuário ainda não possui estratégia definida.</p>
              <button class="btn btn-primary" (click)="onConfigureStrategy()">Criar Estratégia</button>
            </div>
          }
        }

        <!-- Rebalancing Tab -->
        @if (activeTab === 'rebalancing') {
          <div class="rebalancing-content">
            <!-- Summary Section -->
            @if (currentAllocation) {
              <section class="summary-card">
                <div class="summary-header">
                  <h4>Resumo do Portfólio</h4>
                </div>
                <div class="summary-total summary-item">
                  <div class="summary-total-content">
                    <span class="summary-label">Valor Total</span>
                    <span class="summary-value summary-total-value">R$ {{ currentAllocation.current?.total_value | number:'1.2-2' }}</span>
                  </div>
                  <button 
                    type="button"
                    class="btn-primary" 
                    (click)="generateRecommendations()" 
                    [disabled]="isGeneratingRecommendations || !strategy"
                  >
                    {{ isGeneratingRecommendations ? 'Gerando...' : 'Gerar Recomendações de Rebalanceamento' }}
                  </button>
                </div>
                <div class="summary-grid">
                  <div class="summary-item">
                    <span class="summary-label">Valor Total Renda Fixa</span>
                    <div class="summary-item-content">
                      <span class="summary-value">R$ {{ (getRendaFixaTotal()?.value || 0) | number:'1.2-2' }}</span>
                      <span class="summary-percentage">{{ (getRendaFixaTotal()?.percentage || 0) | number:'1.2-2' }}%</span>
                    </div>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Valor Total Renda Variável em Dólar</span>
                    <div class="summary-item-content">
                      <span class="summary-value">R$ {{ (getRendaVarDolaresTotal()?.value || 0) | number:'1.2-2' }}</span>
                      <span class="summary-percentage">{{ (getRendaVarDolaresTotal()?.percentage || 0) | number:'1.2-2' }}%</span>
                    </div>
                  </div>
                  <div class="summary-item">
                    <span class="summary-label">Valor Total Renda Variável em Reais</span>
                    <div class="summary-item-content">
                      <span class="summary-value">R$ {{ (getRendaVarReaisTotal()?.value || 0) | number:'1.2-2' }}</span>
                      <span class="summary-percentage">{{ (getRendaVarReaisTotal()?.percentage || 0) | number:'1.2-2' }}%</span>
                    </div>
                  </div>
                  @if (getFIIActions().length > 0) {
                    <div class="summary-item">
                      <span class="summary-label">Valor Total Fundos Imobiliários</span>
                      <div class="summary-item-content">
                        <span class="summary-value">R$ {{ (getFIITotalSummary()?.value || 0) | number:'1.2-2' }}</span>
                        <span class="summary-percentage">{{ (getFIITotalSummary()?.percentage || 0) | number:'1.2-2' }}%</span>
                      </div>
                    </div>
                  }
                </div>
              </section>
            }

            <!-- Recommendations Display -->
            @if (isLoadingRecommendations) {
              <div class="status-card">
                <p>Carregando recomendações...</p>
              </div>
            } @else if (currentRecommendation) {
              <!-- Renda Fixa Section - Type-Level Summary and Subtype Groups -->
              @if (getRendaFixaActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Renda Fixa - Rebalanceamento</h4>
                  
                  <!-- Type-Level Summary -->
                  @if (getRendaFixaTypeActions().length > 0) {
                    <div class="type-action-group">
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Recomendação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getRendaFixaTypeActions(); track action.id) {
                            <tr>
                              <td><strong>Renda Fixa</strong></td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                      
                      <!-- SubType-Level Summary -->
                      <div class="subtype-level-summary">
                        <table class="actions-table">
                          <thead>
                            <tr>
                              <th>Sub-Tipo de Investimento</th>
                              <th>Valor Atual</th>
                              <th>Valor Alvo</th>
                              <th>Diferença</th>
                              <th>Recomendação</th>
                            </tr>
                          </thead>
                          <tbody>
                            @for (subtypeGroup of getRendaFixaActionsBySubtype(); track subtypeGroup.subtypeName) {
                              @if (subtypeGroup.subtypeActions.length > 0) {
                                @for (action of subtypeGroup.subtypeActions; track action.id) {
                                  <tr>
                                    <td>{{ action.subtype_display_name || action.investment_subtype?.name || action.subtype_name || 'Renda Fixa' }}</td>
                                    <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                    <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                    <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                      R$ {{ action.difference | number:'1.2-2' }}
                                    </td>
                                    <td>
                                      @if (action.quantity_to_buy) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.quantity_to_sell) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else if (action.difference > 0) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.difference < 0) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else {
                                        <span class="badge badge-maintain">Manter</span>
                                      }
                                    </td>
                                  </tr>
                                }
                              }
                            }
                          </tbody>
                        </table>
                      </div>
                    </div>
                  } @else {
                    <!-- Fallback: Show subtype groups if no type-level actions -->
                    <table class="actions-table">
                      <thead>
                        <tr>
                          <th>Sub-Tipo de Investimento</th>
                          <th>Valor Atual</th>
                          <th>Valor Alvo</th>
                          <th>Diferença</th>
                          <th>Recomendação</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (subtypeGroup of getRendaFixaActionsBySubtype(); track subtypeGroup.subtypeName) {
                          @if (subtypeGroup.subtypeActions.length > 0) {
                            @for (action of subtypeGroup.subtypeActions; track action.id) {
                              <tr>
                                <td>{{ action.subtype_display_name || action.investment_subtype?.name || action.subtype_name || 'Renda Fixa' }}</td>
                                <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                  R$ {{ action.difference | number:'1.2-2' }}
                                </td>
                                <td>
                                  @if (action.quantity_to_buy) {
                                    <span class="badge badge-buy">Aumentar</span>
                                  } @else if (action.quantity_to_sell) {
                                    <span class="badge badge-sell">Reduzir</span>
                                  } @else if (action.difference > 0) {
                                    <span class="badge badge-buy">Aumentar</span>
                                  } @else if (action.difference < 0) {
                                    <span class="badge badge-sell">Reduzir</span>
                                  } @else {
                                    <span class="badge badge-maintain">Manter</span>
                                  }
                                </td>
                              </tr>
                            }
                          }
                        }
                      </tbody>
                    </table>
                  }
                </section>
              }

              <!-- Renda Variável em Dólares Section - Nested Structure as per Design -->
              @if (getAcoesDolaresActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Renda Variável em Dólares - Rebalanceamento</h4>
                  
                  <!-- Type-Level Summary -->
                  @if (getRendaVarDolaresTypeActions().length > 0) {
                    <div class="type-action-group">
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Tipo</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getRendaVarDolaresTypeActions(); track action.id) {
                            <tr>
                              <td><strong>Renda Variável em Dólares</strong></td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender</span>
                                } @else if (action.difference > 0) {
                                  <span class="badge badge-buy">Aumentar</span>
                                } @else if (action.difference < 0) {
                                  <span class="badge badge-sell">Reduzir</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                      
                      <!-- SubType-Level Summary - Nested inside Type-Level -->
                      <div class="subtype-level-summary">
                        <!-- Ações em Dólares Subsection (stocks that are not BDRs) -->
                        @if (getAcoesDolaresSubtypeActions().length > 0) {
                          <div class="subtype-action-group">
                            <h5>Ações em Dólares</h5>
                            <table class="actions-table">
                              <thead>
                                <tr>
                                  <th>Ticker</th>
                                  <th>Nome</th>
                                  <th>Valor Atual</th>
                                  <th>Valor Alvo</th>
                                  <th>Diferença</th>
                                  <th>Ação</th>
                                </tr>
                              </thead>
                              <tbody>
                                @for (action of getAcoesDolaresSubtypeActions(); track action.id) {
                                  <tr>
                                    <td><strong>{{ action.stock?.ticker || '-' }}</strong></td>
                                    <td>{{ action.stock?.name || '-' }}</td>
                                    <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                    <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                    <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                      R$ {{ action.difference | number:'1.2-2' }}
                                    </td>
                                    <td>
                                      @if (action.quantity_to_buy) {
                                        <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                      } @else if (action.quantity_to_sell) {
                                        <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                      } @else if (action.difference > 0) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.difference < 0) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else {
                                        <span class="badge badge-maintain">Manter</span>
                                      }
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        }
                        
                        <!-- BDRs Subsection -->
                        @if (getBDRsSubtypeActions().length > 0) {
                          <div class="subtype-action-group">
                            <h5>BDRs</h5>
                            <table class="actions-table">
                              <thead>
                                <tr>
                                  <th>Ticker</th>
                                  <th>Nome</th>
                                  <th>Valor Atual</th>
                                  <th>Valor Alvo</th>
                                  <th>Diferença</th>
                                  <th>Ação</th>
                                </tr>
                              </thead>
                              <tbody>
                                @for (action of getBDRsSubtypeActions(); track action.id) {
                                  <tr>
                                    <td><strong>{{ action.stock?.ticker || '-' }}</strong></td>
                                    <td>{{ action.stock?.name || '-' }}</td>
                                    <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                    <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                    <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                      R$ {{ action.difference | number:'1.2-2' }}
                                    </td>
                                    <td>
                                      @if (action.quantity_to_buy) {
                                        <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                      } @else if (action.quantity_to_sell) {
                                        <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                      } @else if (action.difference > 0) {
                                        <span class="badge badge-buy">Aumentar</span>
                                      } @else if (action.difference < 0) {
                                        <span class="badge badge-sell">Reduzir</span>
                                      } @else {
                                        <span class="badge badge-maintain">Manter</span>
                                      }
                                    </td>
                                  </tr>
                                }
                              </tbody>
                            </table>
                          </div>
                        }
                        
                        <!-- Crypto Subsection -->
                        @for (subtypeGroup of getCryptoSubtypeActionsGrouped(); track subtypeGroup.subtypeName) {
                          @if (subtypeGroup.subtypeActions.length > 0) {
                            <div class="subtype-action-group">
                              <h5>{{ subtypeGroup.subtypeName }}</h5>
                              <table class="actions-table">
                                <thead>
                                  <tr>
                                    <th>Ticker</th>
                                    <th>Nome</th>
                                    <th>Valor Atual</th>
                                    <th>Valor Alvo</th>
                                    <th>Diferença</th>
                                    <th>Ação</th>
                                  </tr>
                                </thead>
                                <tbody>
                                  @for (action of subtypeGroup.subtypeActions; track action.id) {
                                    <tr>
                                      <!-- Show aggregated subtype action, crypto ETF stock, or individual crypto action -->
                                      @if (action.stock) {
                                        <!-- Crypto ETF stock (like HASH11) -->
                                        <td><strong>{{ action.stock.ticker || '-' }}</strong></td>
                                        <td>{{ action.stock.name || '-' }}</td>
                                        <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                        <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                        <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                          R$ {{ action.difference | number:'1.2-2' }}
                                        </td>
                                        <td>
                                          @if (action.quantity_to_buy && action.quantity_to_buy > 0) {
                                            <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                          } @else if (action.quantity_to_sell && action.quantity_to_sell > 0) {
                                            <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                          } @else if (action.difference > 0) {
                                            <span class="badge badge-buy">Comprar</span>
                                          } @else if (action.difference < 0) {
                                            <span class="badge badge-sell">Vender</span>
                                          } @else {
                                            <span class="badge badge-maintain">Manter</span>
                                          }
                                        </td>
                                      } @else if (!isCryptoSymbol(action.subtype_name)) {
                                        <!-- Aggregated subtype action (e.g., "Cryptocurrency" overall) -->
                                        <td><strong>-</strong></td>
                                        <td>{{ action.investment_subtype?.name || 'Cryptocurrency' }}</td>
                                        <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                        <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                        <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                          R$ {{ action.difference | number:'1.2-2' }}
                                        </td>
                                        <td>
                                          @if (action.difference > 0) {
                                            <span class="badge badge-buy">Aumentar</span>
                                          } @else if (action.difference < 0) {
                                            <span class="badge badge-sell">Reduzir</span>
                                          } @else {
                                            <span class="badge badge-maintain">Manter</span>
                                          }
                                        </td>
                                      } @else {
                                        <!-- Individual crypto action (with crypto symbol like "BTC") -->
                                        <td><strong>{{ action.subtype_name || action.crypto_currency_symbol || '-' }}</strong></td>
                                        <td>{{ getCryptoDisplayName(action.crypto_currency_name) }}</td>
                                        <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                                        <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                                        <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                          R$ {{ action.difference | number:'1.2-2' }}
                                        </td>
                                        <td>
                                          @if (action.quantity_to_buy && action.quantity_to_buy > 0) {
                                            <span class="badge badge-buy">
                                              Comprar {{ (action.quantity_to_buy / 1000000) | number:'1.6-6' }} {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}
                                            </span>
                                          } @else if (action.quantity_to_sell && action.quantity_to_sell > 0) {
                                            <span class="badge badge-sell">
                                              Vender {{ (action.quantity_to_sell / 1000000) | number:'1.6-6' }} {{ action.crypto_currency_symbol || action.subtype_name || 'BTC' }}
                                            </span>
                                          } @else if (action.difference > 0) {
                                            <span class="badge badge-buy">Aumentar</span>
                                          } @else if (action.difference < 0) {
                                            <span class="badge badge-sell">Reduzir</span>
                                          } @else {
                                            <span class="badge badge-maintain">Manter</span>
                                          }
                                        </td>
                                      }
                                    </tr>
                                  }
                                </tbody>
                              </table>
                            </div>
                          }
                        }
                      </div>
                    </div>
                  }
                </section>
              }

              <!-- Ações em Reais Section -->
              @if (getAcoesReaisSellActions().length > 0 || getAcoesReaisBuyActions().length > 0 || getAcoesReaisRebalanceActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Ações em Reais - Rebalanceamento</h4>
                  @if (currentRecommendation.sales_limit_reached) {
                    <div class="warning-banner">
                      <strong>Atenção:</strong> O limite de vendas de R$ 19.000 foi atingido. Algumas ações não puderam ser vendidas.
                    </div>
                  }
                  
                  <!-- Sales Limit Info Cards - Location 1 -->
                  <div class="summary-grid">
                    <div class="summary-item">
                      <div class="summary-label">Vendas Já Realizadas no Mês</div>
                      <div class="summary-value">R$ {{ currentRecommendation.previous_sales_this_month | number:'1.2-2' }}</div>
                    </div>
                    <div class="summary-item">
                      <div class="summary-label">Limite Disponível para Vendas</div>
                      <div class="summary-value">R$ {{ getAvailableSalesLimitBeforeRecommendation() | number:'1.2-2' }}</div>
                    </div>
                  </div>
                  
                  <!-- Stocks to Sell -->
                  @if (getAcoesReaisSellActions().length > 0) {
                    <div class="action-group">
                      <h5>Ações para Vender</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ranking</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Atual</th>
                            <th>Quantidade</th>
                            <th>Motivo</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getAcoesReaisSellActions(); track action.id) {
                            <tr>
                              <td>
                                @if (action.display_order && action.display_order < 9999) {
                                  {{ action.display_order }}
                                } @else {
                                  -
                                }
                              </td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>{{ action.quantity_to_sell }}</td>
                              <td>
                                <span class="badge">
                                  @if (action.reason) {
                                    {{ action.reason }}
                                  } @else {
                                    @if (action.display_order && action.display_order < 9999) {
                                      Rank {{ action.display_order }} > 30
                                    } @else {
                                      Não está no AMBB 2.0
                                    }
                                  }
                                </span>
                              </td>
                              <td>
                                @if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender {{ action.quantity_to_sell }}</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }

                  <!-- Sales Limit Info Cards - Location 2 -->
                  <div class="summary-grid">
                    <div class="summary-item">
                      <div class="summary-label">Total Vendas - Liquidadas</div>
                      <div class="summary-value">R$ {{ currentRecommendation.total_complete_sales_value | number:'1.2-2' }}</div>
                    </div>
                    <div class="summary-item">
                      <div class="summary-label">Limite para Vendas Parciais</div>
                      <div class="summary-value">R$ {{ (19000 - currentRecommendation.previous_sales_this_month - currentRecommendation.total_complete_sales_value) | number:'1.2-2' }}</div>
                    </div>
                  </div>

                  <!-- Stocks to Buy -->
                  @if (getAcoesReaisBuyActions().length > 0) {
                    <div class="action-group">
                      <h5>Ações para Comprar</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ranking</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Alvo</th>
                            <th>Quantidade</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getAcoesReaisBuyActions(); track action.id) {
                            <tr>
                              <td>{{ action.display_order }}</td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td>{{ action.quantity_to_buy }}</td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }

                  <!-- Stocks to Balance -->
                  @if (getAcoesReaisRebalanceActions().length > 0) {
                    <div class="action-group">
                      <h5>Ações para Rebalancear</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ranking</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getAcoesReaisRebalanceActions(); track action.id) {
                            <tr>
                              <td>{{ action.display_order }}</td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }

                  <!-- Sales Limit Info Cards - Location 3 -->
                  <div class="summary-grid">
                    <div class="summary-item">
                      <div class="summary-label">Vendas Parciais</div>
                      <div class="summary-value">R$ {{ currentRecommendation.total_partial_sales_value | number:'1.2-2' }}</div>
                    </div>
                    <div class="summary-item">
                      <div class="summary-label">Limite de Vendas Restante</div>
                      <div class="summary-value">R$ {{ currentRecommendation.sales_limit_remaining | number:'1.2-2' }}</div>
                    </div>
                    <div class="summary-item">
                      <div class="summary-label">Total Ativos em Reais Após Rebalanceamento</div>
                      <div class="summary-value">R$ {{ getTotalAcoesReaisValueAfterRebalancing() | number:'1.2-2' }}</div>
                    </div>
                  </div>
                </section>
              }

              <!-- Fundos Imobiliários (FIIs) Section -->
              @if (getFIISellActions().length > 0 || getFIIBuyActions().length > 0 || getFIIRebalanceActions().length > 0) {
                <section class="rebalancing-section">
                  <h4>Fundos Imobiliários (FIIs) - Rebalanceamento</h4>
                  
                  <!-- FIIs to Sell -->
                  @if (getFIISellActions().length > 0) {
                    <div class="action-group">
                      <h5>FIIs para Vender</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ordem</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Atual</th>
                            <th>Quantidade</th>
                            <th>Motivo</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getFIISellActions(); track action.id) {
                            <tr>
                              <td>
                                @if (action.display_order && action.display_order < 9999) {
                                  {{ action.display_order }}
                                } @else {
                                  -
                                }
                              </td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>{{ action.quantity_to_sell }}</td>
                              <td>
                                <span class="badge">
                                  @if (action.reason) {
                                    {{ action.reason }}
                                  } @else {
                                    FII não está na estratégia configurada
                                  }
                                </span>
                              </td>
                              <td>
                                @if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender {{ action.quantity_to_sell }}</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }

                  <!-- FIIs to Buy -->
                  @if (getFIIBuyActions().length > 0) {
                    <div class="action-group">
                      <h5>FIIs para Comprar</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ordem</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Alvo</th>
                            <th>Quantidade</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getFIIBuyActions(); track action.id) {
                            <tr>
                              <td>{{ action.display_order }}</td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td>{{ action.quantity_to_buy }}</td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }

                  <!-- FIIs to Rebalance -->
                  @if (getFIIRebalanceActions().length > 0) {
                    <div class="action-group">
                      <h5>FIIs para Rebalancear</h5>
                      <table class="actions-table">
                        <thead>
                          <tr>
                            <th>Ordem</th>
                            <th>Ticker</th>
                            <th>Nome</th>
                            <th>Valor Atual</th>
                            <th>Valor Alvo</th>
                            <th>Diferença</th>
                            <th>Ação</th>
                          </tr>
                        </thead>
                        <tbody>
                          @for (action of getFIIRebalanceActions(); track action.id) {
                            <tr>
                              <td>{{ action.display_order }}</td>
                              <td><strong>{{ action.stock?.ticker }}</strong></td>
                              <td>{{ action.stock?.name }}</td>
                              <td>R$ {{ action.current_value | number:'1.2-2' }}</td>
                              <td>R$ {{ action.target_value | number:'1.2-2' }}</td>
                              <td [class.positive]="action.difference > 0" [class.negative]="action.difference < 0">
                                R$ {{ action.difference | number:'1.2-2' }}
                              </td>
                              <td>
                                @if (action.quantity_to_buy) {
                                  <span class="badge badge-buy">Comprar {{ action.quantity_to_buy }}</span>
                                } @else if (action.quantity_to_sell) {
                                  <span class="badge badge-sell">Vender {{ Math.abs(action.quantity_to_sell) }}</span>
                                } @else {
                                  <span class="badge badge-maintain">Manter</span>
                                }
                              </td>
                            </tr>
                          }
                        </tbody>
                      </table>
                    </div>
                  }
                </section>
              }

              <!-- Recommendation Actions -->
              <div class="actions-bar">
                <button 
                  class="btn btn-success" 
                  (click)="applyRecommendation(currentRecommendation.id)"
                >
                  Aplicar Recomendação
                </button>
                <button 
                  class="btn btn-secondary" 
                  (click)="dismissRecommendation(currentRecommendation.id)"
                >
                  Descartar
                </button>
              </div>
            } @else if (!isGeneratingRecommendations) {
              <div class="empty-card">
                <p>Nenhuma recomendação de rebalanceamento disponível.</p>
                <p class="hint">Clique em "Gerar Recomendações" para criar uma nova recomendação mensal.</p>
              </div>
            }
          </div>
        }
      </div>
    }
  </section>
</div>
